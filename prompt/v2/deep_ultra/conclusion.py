# -*- coding: utf-8 -*-
"""
结论生成 Prompt（v2 重构版 - 含 CoT）

生成文章收尾部分：
- 洞见延伸（超越正文的独立思考）
- 金句&原声引用
"""

from ._base import get_base_context, get_quality_rules

# ============================================================
# 结论生成 Prompt 模板
# ============================================================

CONCLUSION_PROMPT_TEMPLATE = """
{base_context}

---

# 任务目标

为深度解读文章生成收尾部分：**洞见延伸**和**金句&原声引用**。

---

# 全局上下文

## 原始内容
<source_content>
{full_content}
</source_content>

## 已生成的全部正文内容
<generated_chapters>
{all_generated_chapters}
</generated_chapters>

---

# 思考过程（Chain-of-Thought）

请按以下步骤逐步思考，确保结论质量：

## 步骤 1：正文核心论点回顾

快速列出正文中已经详细论述的核心论点：
- 论点 1：...
- 论点 2：...
- ...

**注意**：洞见延伸不能是这些论点的复述。

## 步骤 2：外延推理空间识别

基于正文事实，识别可以进行外延推理的方向：

| 正文事实 | 可延伸方向 |
|---------|-----------|
| AWS 用风冷降成本 | 对中小云厂商的启示 |
| Trainium3 支持 MoE | MoE 对芯片设计范式的长期影响 |
| ... | ... |

## 步骤 3：洞见质量自检

对于每条洞见，回答：
1. 这是正文已经详细论述的吗？→ 如果是，删除
2. 这是基于正文事实的外延推理吗？→ 如果不是，删除
3. 读者看完能获得新视角吗？→ 如果不能，重写

## 步骤 4：金句筛选

从原文中筛选金句的标准：
- 有冲击力、有画面感
- 体现说话者的核心观点或独特视角
- 具有引用价值

---

# 输出要求

## 1. 洞见延伸

**定义**：基于正文事实进行**外延推理**，提供正文未明确提及的新视角

**数量**：5-10 条，具有可操作性的启示

**格式**：
```markdown
### 洞见延伸

1. **[洞见标题：必须是新视角，而非正文要点]**
   [洞见详细内容，基于正文事实的外延推理]

2. **[洞见标题]**
   [洞见详细内容]
...
```

**禁止**：
- ❌ 复述正文已详细论述的观点
- ❌ 以"文章提到..."或"正如第X章所述..."开头
- ❌ 纯粹的事实还原（如"AWS通过风冷设计降低了TCO"）

**必须**：
- ✅ 基于正文事实，推导出正文未直接阐述的结论
- ✅ 每条洞见包含**新视角**或**外延启示**

**示例对照**：

| 正文内容 | ❌ 不合格洞见（复述） | ✅ 合格洞见（外延） |
|---------|---------------------|-------------------|
| AWS用风冷降成本 | AWS通过风冷设计降低了TCO | 风冷策略对中小云厂商的启示：运维简化可能比极致性能更重要 |
| Trainium3支持MoE | Trainium3的软件栈转向原生PyTorch | MoE架构正在重塑芯片设计哲学：稀疏计算需要新的内存层次结构 |

## 2. 金句&原声引用

**定义**：从原文中挑选有代表性的原句，附中文翻译

**数量**：5-10 条

**格式**：
```markdown
### 金句&原声引用

1. > **"[English original quote]"**
   > "[中文翻译]"

2. > **"[中文原声]"**
...
```

**说明**：
- 英文原句需附中文翻译
- 中文金句只需输出一行
- 使用引用块格式（`>`）

---

# 约束条件

1. **结合正文**：输出的洞见和金句必须结合已生成的正文内容
2. **不要超纲**：不要输出原内容中有但正文中没有提到的内容
3. **格式严格**：必须使用 `### 洞见延伸` 和 `### 金句&原声引用` 作为标题
4. **纯净输出**：不要输出其他标题、大纲或任何正文内容

---

{quality_rules}

---

**现在，请生成洞见延伸和金句：**
"""


def build_conclusion_prompt(
    full_content: str,
    all_generated_chapters: str
) -> str:
    """
    构建结论生成 prompt
    
    Args:
        full_content: 原始内容
        all_generated_chapters: 已生成的全部正文内容
        
    Returns:
        格式化后的 prompt
    """
    return CONCLUSION_PROMPT_TEMPLATE.format(
        base_context=get_base_context(),
        quality_rules=get_quality_rules(),
        full_content=full_content,
        all_generated_chapters=all_generated_chapters
    )
