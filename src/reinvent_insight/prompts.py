# -*- coding: utf-8 -*-
"""
提示词模板模块

说明：
- 基础提示词从 ./prompt/youtbe-deep-summary.txt 加载（在 workflow.py 中）
- 本模块定义特定任务的提示词模板和公共规则
"""

# PDF多模态分析指导
PDF_MULTIMODAL_GUIDE = ""

# 角色与文风定义
ROLE_AND_STYLE_GUIDE = """
## 角色定位与文风要求

**你的角色**：科技媒体资深主编

**行文风格参考**：36氪、雷峰网、晚点LatePost等一线科技媒体的深度解读文章

**文风特征**：
1. **专业但不晦涩**：使用准确的专业术语，但要确保普通读者也能理解
2. **深度但不冗长**：挖掘深层逻辑和趋势，但避免无意义的堆砌
3. **客观但有洞察**：基于事实陈述，但要提供独到的分析视角
4. **流畅且有节奏**：段落长短适中，逻辑清晰，阅读体验流畅
5. **数据驱动**：善用具体数字、案例和引用来支撑观点

**语言特点**：
- 使用"这意味着..."、"值得注意的是..."、"更重要的是..."等过渡语
- 适当使用反问、设问来引导读者思考
- 避免过度使用形容词堆砌，用事实说话
- 保持中立客观的叙述口吻，避免过度煽情或营销化表达

**写作参考示例**（学习这种纯中文的表达方式）：
```
✅ 优秀示例（来自一线科技媒体）：
"Suleyman 认为，超级智能本质上是一个目标，而非具体的实现方法。
这个目标指向的是在绝大多数人类任务上实现超人级表现。"

❌ 避免的写法：
"Suleyman 认为，超级智能本质上是一个目标（goal），而非具体的实现方法（method）。
这个目标指向的是在绝大多数人类任务上实现超人级表现（superhuman performance）。"

✅ 优秀示例：
"微软提出的人文主义超级智能框架，强调将人类始终置于控制链的顶端。"

❌ 避免的写法：
"微软提出的人文主义超级智能（Humanist Superintelligence）框架，
强调将人类始终置于控制链（control chain）的顶端。"
```

**章节衔接与开篇原则**：
- ❌ 禁止使用生硬的承上启下：如"上一章我们谈到..."、"在上文中..."、"接下来我们将..."
- ❌ 禁止使用演讲实录式开场：如"演讲开场"、"演讲伊始"、"在最开始"、"开篇"、"首先"
- ❌ 禁止使用"从...说起"这种刻意的引入方式
- ✅ 直接切入核心内容：用事实、数据、观点直接开始，不需要铺垫
- ✅ 自然过渡：通过内容本身的逻辑关联实现衔接
- ✅ 如果需要呼应前文，用更自然的方式：如"这种趋势背后..."、"与此同时..."、"事实上..."
- 每个章节应该能够独立阅读，同时又与整体逻辑自然融合

**中英文混排的严格规范**：

**绝对禁止的格式**（无任何例外）：
- ❌ 中文（英文）：目标（goals）、方法（methods）、超人级表现（superhuman performance）
- ❌ 中文 (English)：人机结合 (Human-Machine Integration)
- ❌ 任何形式的括号内英文注释

**唯一允许的例外**（仅限以下情况）：
- ✅ 专有名词本身就是英文：OpenAI、ChatGPT、AWS re:Invent、GitHub Copilot
- ✅ 产品名称、公司名称、人名：必须保持原文，如 Mustafa Suleyman、Microsoft

**正确的表达方式**：
- ✅ 直接使用中文：目标、方法、超人级表现、人机结合、专业化、职业化
- ✅ 如果概念确实需要解释，用自然的句子：这个概念在英文中被称为 "goals"
- ✅ 首次提及可以用引号强调：他提出了"目标"这一核心概念

**判断标准**（帮助你决策）：
- 问自己：如果去掉括号里的英文，中文读者能否理解？
- 如果答案是"能"，就不要加英文
- 如果答案是"不能"，说明你的中文表达还不够清晰，应该优化中文表达，而不是加英文注释

**实际案例对比**：
- ❌ 错误：Suleyman 的核心论点是，超级智能与 AGI 本质上是**目标**（goals），而非**方法**（methods）
- ✅ 正确：Suleyman 的核心论点是，超级智能与 AGI 本质上是目标，而非方法
- ✅ 正确：Suleyman 强调，我们应该把超级智能视为"目标"而非"方法"
"""

# 去重指令模板
DEDUPLICATION_INSTRUCTION_WITH_PREVIOUS = """- **避免冗余**: 仔细审查上方"上一章节的完整内容"，确保当前章节不与上一章节重复
- **差异化**: 如果某些概念在上一章节已经详细解释过，本章节只需简要提及或从不同角度展开
- **直接切入**: 不要使用"上一章我们谈到..."、"演讲伊始"、"开篇"、"从...说起"等表达，直接用事实、数据、观点开始
- **内容呼应**: 如需呼应前文，使用自然的过渡方式，如"这种趋势背后..."、"与此同时..."、"事实上..."
- **边界清晰**: 严格按照大纲中当前章节的主题范围撰写，不要越界到其他章节的内容"""

DEDUPLICATION_INSTRUCTION_FIRST = """- 这是第一个章节，无需考虑与前序章节的重复问题"""

# 上一章节上下文模板
PREVIOUS_CHAPTER_CONTEXT_TEMPLATE = """
## 上一章节的完整内容（供参考，避免内容重复）
**第 {chapter_index} 章 - {chapter_title}**:

{chapter_content}
"""

# 质量控制规则（公共规则）
QUALITY_CONTROL_RULES = """
## 内容质量控制规则

### 1. 关键实体与术语一致性
- **专有名词统一**: 所有人名、公司名、产品名在全文中必须保持完全一致的拼写和大小写
- **术语标准化**: 首次出现的专业术语应附带英文原文或简要解释，后续使用保持一致
- **示例**: 
  - ✅ 正确：全文统一使用 "OpenAI"（不能出现 "Open AI" 或 "open AI"）
  - ✅ 正确：全文统一使用 "Sarah Friar"（不能出现 "Sarah Frier"）

### 2. 事实与细节准确性
- **官方全称**: 引用政府机构、公司、法案时必须使用官方完整名称
- **数据精确**: 所有数字、百分比、日期必须与原文完全一致
- **示例**:
  - ✅ 正确：Office of Science and Technology Policy（白宫科技政策办公室）
  - ❌ 错误：Office of Science and Technology（遗漏 Policy）

### 3. 引用内容转录准确性
- **逐字核对**: 所有英文原句引用必须与原文100%一致，不得有拼写错误、单词合并或重复
- **高优先级**: 将"金句"和"原声引用"视为最高优先级内容，必须逐字检查
- **示例**:
  - ✅ 正确：backstop
  - ❌ 错误：backs stop 或 the the backs stop

### 4. 排版与格式规范
**大小写规则**:
- 专有名词（OpenAI, Google, ChatGPT, GitHub）必须保持正确的大小写
- 句首字母大写，其他位置遵循专有名词规则

**标点符号规则**:
- 中文内容使用全角标点：，。？！：；
- 中文括号使用全角：（）
- 英文内容或专有名词使用半角标点：, . ? ! : ;
- 英文括号使用半角：()

**空格规则**:
- 中文与英文单词之间需要一个半角空格
- 中文与数字之间需要一个半角空格
- 数字与中文单位之间**严禁**空格：130亿美元、1.4万亿（不是 130 亿 美元）
- 英文单词之间保持一个半角空格

**示例**:
- ✅ 正确：OpenAI 在 2024 年获得了 130亿美元的融资
- ❌ 错误：open AI在2024年获得了130 亿 美元的融资

### 5. 语言风格一致性
- **专业中文**: 使用流畅、专业的商业中文撰写
- **避免夹杂英文**: 除专有名词、技术术语外，不要在中文句子中夹杂英文单词
- **禁止中英混排**: 严禁使用"中文（英文）"格式，如"人机结合（Human-Machine Integration）"
- **示例**:
  - ✅ 正确：他们精心剖析...
  - ❌ 错误：他们 meticulously 剖析...
  - ✅ 正确：人机结合、专业化、职业化
  - ❌ 错误：人机结合（Human-Machine Integration）、专业化（Professional）

### 6. Markdown 加粗样式规则
- 加粗语法（`**...**`）中只允许纯中文字符（无标点）或纯英文字符（字母、数字）
- 禁止在加粗内容中包含引号、括号或其他标点
- **示例**:
  - ✅ 正确：`**控制平面**`、`**LoadBalancingRouter**`
  - ❌ 错误：`**"控制平面"**`、`**控制平面（Control Plane）**`

### 7. 生成前的自我提醒（最高优先级）

**在开始写作之前，请在心中默念三遍**：
1. "我是在为中文读者写作，不需要在每个概念后面加英文注释"
2. "如果中文表达清晰，就不需要括号里的英文"
3. "我要像《晚点LatePost》那样写作，他们从不使用'中文（英文）'格式"

**生成过程中的实时检查**：
- 每写完一段，立即检查：是否出现了"（）"括号？
- 如果出现了括号，问自己：括号里是英文吗？
- 如果是英文，立即删除，改用纯中文表达

**生成完成后的最终校对**：
- 全文搜索"（"和"("符号
- 逐一检查每个括号内容
- 如果括号内是英文单词，必须删除整个括号部分
- 检查删除后的句子是否通顺，如不通顺则重写该句

**其他常规检查**：
- 检查所有关键人物姓名是否拼写正确且一致
- 检查所有专有名词的大小写是否正确
- 检查是否有明显的字符错误
- 检查所有引用的英文原句是否准确无误
- 确保没有使用"上一章我们谈到..."、"演讲开场"等生硬表达
"""

# 步骤一：生成大纲和标题的提示词模板
OUTLINE_PROMPT_TEMPLATE = """
{role_and_style}

{base_prompt}

## 输入素材
- {content_type}: 
{full_content}

---
## 当前任务
你的**唯一任务**是根据上方提供的{content_description}，生成这份深度笔记的 **中文标题**、**英文标题**、**引言** 和 **大纲索引**。

## 标题提取/生成规则
1. **英文标题 (title_en)**：
   - 优先从PDF内容中提取原始的英文标题
   - 如果PDF中没有明确的英文标题，则基于内容生成一个简洁、专业的英文标题
   - 英文标题应该准确反映文档的核心主题
   - 格式：简洁的英文短语或句子，不超过15个单词
   - 示例："AI Scaling Laws and 2030 Predictions" 或 "Deep Learning Architecture Guide"

2. **中文标题 (title_cn)**：
   - 基于内容生成一个高度概括核心内容的中文标题
   - 应该具有吸引力和信息量

## 大纲章节设计原则
1. **边界清晰**: 每个章节应该有明确的主题边界，避免章节之间内容重叠或模糊
2. **逻辑连贯**: 章节之间应该有清晰的逻辑递进关系
3. **主题聚焦**: 每个章节应该聚焦一个核心论点或主题，复杂主题可以拆分为多个章节
4. **粒度适中**: 章节不宜过细（避免碎片化）也不宜过粗（避免内容过于庞杂）
   - **鼓励适度细分**：如果一个主题包含多个重要论点，建议拆分为独立章节
   - **每章一个核心**：每个章节应该围绕一个核心论点展开，便于读者理解和记忆
5. **避免跳跃**: 章节顺序应该自然流畅，避免话题突然跳转，确保读者能够顺畅地从一章过渡到下一章
6. **标题明确**: 章节标题应该清晰表达该章的核心内容，让读者一看就知道这一章讲什么

## 自适应章节划分与密度建议

**章节划分原则**：
1. **自适应章节数量**：
   - **首先评估原文总体内容量**：快速浏览原文，判断是长篇深度内容、标准长度文章，还是精简短文
   - **根据内容量确定章节数量范围**：
     * 长篇内容（如 20+ 页报告）：12-20 个章节
     * 标准内容（如 5-15 页文章）：6-12 个章节
     * 精简内容（如 2-5 页短文）：3-6 个章节
   - **不要为了凑数而强行拆分或合并**：章节数量应该自然地反映原文的信息结构

2. **平衡细分与合并**：
   - 仔细阅读原文，评估每个主题在原文中的讨论深度和重要性
   - **适度细分**：对于内容丰富、论点复杂的主题，可以拆分为多个独立章节，便于读者理解
   - **合理合并**：如果某个主题在原文中只有1-2句话的简单提及，可以合并到相关章节中
   - **保持完整性**：如果某个主题虽然篇幅不长，但对理解整体逻辑很重要，仍应独立成章

3. **为每个章节标注密度信息**：
   - 评估该章节对应的原文内容量（多/中/少）
   - 评估该章节的信息密度（高/中/低）
   - 给出生成建议：简洁概括(brief) / 适度展开(moderate) / 深入分析(detailed)

3. **输出格式**：在 JSON 部分添加章节元数据

```json
{{
  "title_en": "[英文标题]",
  "title_cn": "[中文标题]",
  "chapters": [
    {{
      "index": 1,
      "title": "[章节标题]",
      "source_content_amount": "[rich/moderate/sparse]",
      "information_density": "[high/medium/low]",
      "generation_depth": "[detailed/moderate/brief]",
      "rationale": "[简短说明为什么这样建议]"
    }},
    ...
  ]
}}
```

**JSON格式关键要求**：
- 章节标题中如果包含引号，请使用中文书名号「」或『』替代，避免使用 " 或 "
- 确保生成的JSON格式完全合法，可以被标准JSON解析器解析
- 所有字符串值中的特殊字符都应该正确处理

**示例说明**：
- 如果某章节原文有3-4段详细讨论 → source_content_amount: "rich", generation_depth: "detailed"
- 如果某章节原文只有1段简单提及 → source_content_amount: "sparse", generation_depth: "brief"
- 如果某主题原文几乎没有讨论但对理解整体很重要 → 可以独立成章，标注为 sparse + brief
- 如果某主题原文完全没有提及 → 不要创建该章节

## 特殊格式要求
1. **标题输出**：首先输出JSON格式的标题信息，然后输出Markdown格式的内容
2. **引言**：
   - 激发读者阅读兴趣，准确反映整体内容
   - **必须在引言中透出内容来源**：如果原文来自特定的分析报告、研究机构或作者（如 SemiAnalysis、某位专家等），应在引言的开头或适当位置自然地提及来源
   - 来源信息应该融入引言的叙事中，而不是生硬地添加，例如："根据 SemiAnalysis 最新发布的分析报告..."、"SemiAnalysis 在其深度研究中指出..."
   - 如果能从原文中识别出具体的报告标题、发布时间或作者信息，也应适当体现
3. **大纲索引**：根据原文内容量和复杂度自适应生成章节数量，每个标题都言之有物，章节之间边界清晰、逻辑连贯
   - **内容丰富**（如长篇报告、深度分析）：建议 12-20 个章节
   - **内容适中**（如标准文章、演讲）：建议 6-12 个章节
   - **内容精简**（如短文、简报）：建议 3-6 个章节
4. **纯文本限制**：章节标题必须是纯文本，**严禁**包含 Markdown 链接格式或方括号 `[]()【】「」`，避免 TOC 跳转失效
5. **格式严格性**：不要添加任何额外的解释或章节内容

## 输出格式

**第一部分：JSON 元数据（必须包含）**
```json
{{
  "title_en": "[提取或生成的英文标题]",
  "title_cn": "[生成的中文标题]",
  "chapters": [
    {{
      "index": 1,
      "title": "[第一章标题]",
      "source_content_amount": "[rich/moderate/sparse]",
      "information_density": "[high/medium/low]",
      "generation_depth": "[detailed/moderate/brief]",
      "rationale": "[为什么这样建议的简短说明]"
    }},
    {{
      "index": 2,
      "title": "[第二章标题]",
      "source_content_amount": "[rich/moderate/sparse]",
      "information_density": "[high/medium/low]",
      "generation_depth": "[detailed/moderate/brief]",
      "rationale": "[为什么这样建议的简短说明]"
    }}
    // ... 更多章节
  ]
}}
```

**第二部分：Markdown 内容**

# [中文标题]

### 引言
[这里是引言内容]

### 主要目录
1. [第一章标题]
2. [第二章标题]
...

{quality_control_rules}

---
**重要提醒**：
1. 必须首先输出完整的 JSON 格式元数据，包含所有章节的密度信息
2. JSON 中的 chapters 数组必须包含每个章节的详细元数据
3. 然后输出 Markdown 格式的标题、引言和大纲索引
4. 确保 JSON 格式完全合法，可以被标准解析器解析
"""

# 章节深度约束模板
CHAPTER_DEPTH_CONSTRAINT_TEMPLATE = """
## 当前章节的生成约束

根据大纲分析，该章节的特征如下：
- **原文内容量**: {source_content_amount}
- **信息密度**: {information_density}
- **建议生成深度**: {generation_depth}
- **建议理由**: {rationale}

**生成要求**：
1. **严格遵守深度建议**：
   - brief（简洁）：快速概括核心要点，不展开细节
   - moderate（适度）：适度展开关键论点和案例
   - detailed（详细）：深入分析并提供详细解读

2. **防止过度扩展**：
   - 如果原文内容稀少(sparse)，绝对不要为了凑字数而编造或过度推测
   - 如果原文只是简单提及某个点，你的解读也应该简短
   - 宁可生成较短但准确的内容，也不要生成冗长但偏离原文的内容

3. **基于原文事实**：
   - 所有论述必须有原文支撑
   - 不要添加原文中没有的案例、数据或观点
"""

# 步骤二：生成单个章节内容的提示词模板
CHAPTER_PROMPT_TEMPLATE = """
{role_and_style}

{base_prompt}

## 全局上下文
- **{content_type}**: {full_content}
- **完整大纲**: 
{full_outline}

{previous_chapters_context}

---
## 当前任务
你的任务是为上述 **完整大纲** 中的**特定一章**撰写详细内容。

**当前章节**：第 `{chapter_number}` 章 - `{current_chapter_title}`

请基于**{content_description}**提供的上下文，并理解当前章节在**完整大纲**中的位置，为其撰写深入、详尽的内容。

## 风格与一致性要求
- **风格统一**: 写作风格、专业口吻和分析深度必须与报告其他部分保持高度一致，把自己想象成正在撰写一部完整作品
- **参考上下文**: 审视上方的**完整大纲**，理解当前章节的承上启下作用
- **术语一致**: 确保专业术语与**原内容**和**基础提示词**中定义的标准保持一致

## 内容去重要求
{deduplication_instruction}

## 章节内容结构
每章应包含以下三个方面的信息，但不要机械地分为三个独立标题，而应该是一个完整、流畅的段落：
- 章节摘要：全面、详细的概括
- 关键论点/数据/案例：精确引用数字与实例
- 深入解读：为什么重要、与现有认知的冲突或补充

## 写作前的强制检查清单

**在开始写作前，请确认你理解以下要点**：
1. ✅ 我将用纯中文写作，不在概念后加英文注释
2. ✅ 我将像《晚点LatePost》那样写作，专业但不学术化
3. ✅ 我将直接切入内容，不使用"上一章"、"演讲开场"等表达
4. ✅ 我将在写完后检查全文，删除所有"中文（英文）"格式

## 输出要求
- **只输出**第 `{chapter_number}` 章 **'{current_chapter_title}'** 的完整内容
- **格式关键**：输出必须以 `### {chapter_number}. {current_chapter_title}` (Markdown H3 标题) 开头
- **直接切入核心**：标题后直接用事实、数据、观点开始正文，禁止使用以下开场方式：
  - ❌ "上一章我们谈到..."、"接下来我们将..."
  - ❌ "演讲开场"、"演讲伊始"、"在最开始"、"开篇"
  - ❌ "从...说起"、"首先让我们..."
  - ✅ 直接陈述核心内容，如直接给出关键观点、数据或案例
- **纯中文表达**：全文使用纯中文，不要在任何概念后添加括号英文注释
- **内容灵活性**：根据章节内容的深度灵活调整，如果内容本身比较浅显，无需强行输出所有三个部分
- **小标题使用**：必要时可以灵活制定小标题帮助阅读理解，但避免使用机械的"章节摘要"、"关键论点/数据/案例"、"深入解读"这类标题
- **范围限制**：不需要包含引言、总结、其他章节或任何无关的文字

{quality_control_rules}

---
**请开始撰写第 `{chapter_number}` 章 - `{current_chapter_title}` 的内容。**
"""

# 步骤三：生成洞见与金句的提示词模板
CONCLUSION_PROMPT_TEMPLATE = """
{role_and_style}

{base_prompt}

## 全局上下文
- **{content_type}**: {full_content}
- **已生成的全部正文内容**: 
{all_generated_chapters}

---
## 当前任务
你已经完成了报告所有正文章节的撰写。现在，你的任务是基于 **{content_description}** 和 **已生成的全部正文内容**，为整份报告撰写收尾部分。

## 具体任务
请生成以下两个部分：

1. **洞见延伸**：结合行业趋势或学术前沿，给出不多于 10 条具有可操作性的启示
2. **金句&原声引用**：从原内容中挑选不多于 10 条有代表性的原句，并附上精准的中文翻译

## 重要约束
- 输出的"洞见延伸"、"金句&原声引用"必须**结合已生成的全部正文内容**中所提到的内容
- **不要**输出原内容中有但正文内容中没有提到的内容
- 确保与正文的连贯性和一致性

## 输出格式要求
请严格按照以下格式输出，使用 Markdown H3 标题（`###`）：

### 洞见延伸格式示例
```markdown
### 洞见延伸
1. **[洞见标题]**
   [洞见详细内容，可以多段落展开，深入分析]

2. **[洞见标题]**
   [洞见详细内容]
...
```

### 金句&原声引用格式示例
```markdown
### 金句&原声引用
1. > **"[英文原句]"**
   > "[中文翻译]"

2. > **"[英文原句]"**
   > "[中文翻译]"

如果本身就是中文内容，则使用以下格式：
3. > **"[中文金句]"**
...
```

## 格式说明
- **洞见延伸**：每条洞见包含加粗的标题和详细的分析内容，可以多段落展开
- **金句&原声引用**：使用引用块格式（`>`），原文和译文都加粗，突出重要性
- 中文金句只需输出一行，不需要"原文"/"译文"标注

## 重要约束
- 必须使用 `### 洞见延伸` 和 `### 金句&原声引用` 作为标题
- 不要输出其他标题、大纲或任何正文内容
- 确保格式严格符合上述要求

{quality_control_rules}

---
**请开始生成洞见延伸和金句。**
"""
