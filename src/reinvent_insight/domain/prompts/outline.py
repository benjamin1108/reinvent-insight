# -*- coding: utf-8 -*-
"""
大纲生成提示词模板
"""

# 步骤一：生成大纲和标题的提示词模板
OUTLINE_PROMPT_TEMPLATE = """
{role_and_style}

{base_prompt}

## 输入素材
- {content_type}: 
{full_content}

---
## 当前任务
你的**唯一任务**是根据上方提供的{content_description}，生成这份深度笔记的 **中文标题**、**英文标题**、**引言** 和 **大纲索引**。

## 标题提取/生成规则
1. **英文标题 (title_en)**：
   - 优先从PDF内容中提取原始的英文标题
   - 如果PDF中没有明确的英文标题，则基于内容生成一个简洁、专业的英文标题
   - 英文标题应该准确反映文档的核心主题
   - 格式：简洁的英文短语或句子，不超过15个单词
   - 示例："AI Scaling Laws and 2030 Predictions" 或 "Deep Learning Architecture Guide"

2. **中文标题 (title_cn)**：
   - 基于内容生成一个高度概括核心内容的中文标题
   - 应该具有吸引力和信息量

## 内容类型识别与章节设计策略

**第一步：识别内容类型**
在设计大纲前，请先判断原文属于以下哪种类型：

1. **产品发布会/Keynote**（如 AWS re:Invent、Apple WWDC、Google I/O）
   - **特征**：混合型内容，既包含产品发布，也包含战略理念、技术趋势、行业洞察
   - **内容分类**：
     * 产品发布部分：新产品/新功能/版本更新/性能参数/价格信息
     * 理念讲解部分：技术愿景/设计哲学/方法论/最佳实践/行业趋势
     * 客户案例部分：真实应用场景/业务价值/技术实践
   
   - **章节设计要求**：
     * ✅ **混合章节策略**：根据每个章节的实际内容选择合适的标题风格
       - 产品发布章节 → 使用具体产品名 + 版本 + 核心亮点
       - 理念讲解章节 → 使用概念化表达 + 核心观点
       - 客户案例章节 → 使用公司名 + 应用场景 + 关键成果
     
     * ✅ **标题示例对照**：
       - 产品类：「Trainium 2 芯片正式商用：AI 训练性能提升4倍」
       - 理念类：「云原生时代的长期主义：AWS 的基础设施承诺」
       - 案例类：「Apple Intelligence 案例：支撑全球10亿设备的云端算力架构」
       - 方法论类：「消除 AI 幻觉：自动化推理检查的工程实践」
     
     * ✅ **内容组织逻辑**：
       - 开场理念 → 核心产品发布 → 技术深度解读 → 客户案例 → 未来展望
       - 或按产品线：基础设施 → 数据服务 → AI 服务 → 开发工具
     
     * ⚠️ **灵活性原则**：
       - 不强制要求所有章节都是产品发布
       - CTO/技术高管演讲往往侧重方法论和技术理念，应尊重原文重心
       - 对于确实是新产品/新功能的章节，才使用版本号和参数化标题

2. **技术深度解读/Deep Dive**（如 AWS Deep Dive、技术分享会、架构解析）
   - **特征**：深入剖析某个具体技术/产品/服务的设计、实现、优化细节
   - **章节设计要求**：
     * ✅ **问题导向**：每章围绕一个核心技术挑战或设计决策
     * ✅ **层次递进**：概述 → 架构设计 → 核心机制 → 性能优化 → 最佳实践
     * ✅ **技术深度**：包含架构图、数据流、算法原理、性能指标
     * ✅ **实战导向**：强调「如何实现」「为什么这样设计」「有哪些坑」
   
   - **标题示例**：
     * 「Lambda 冷启动优化：从5秒到50毫秒的技术演进」
     * 「DynamoDB 全局表的一致性模型：CRDTs 在分布式系统中的应用」
     * 「S3 的11个9可靠性：跨AZ复制与自动修复机制」

3. **长篇访谈/对话**（如播客访谈、圆桌讨论、创始人对话）
   - **特征**：问答式结构，围绕嘉宾观点/经历/洞察展开，话题跳跃性较大
   - **章节设计要求**：
     * ✅ **主题聚类**：将分散的对话内容按主题重新组织（而非按时间顺序）
     * ✅ **观点提炼**：每章提炼出嘉宾的核心观点或故事
     * ✅ **人物视角**：标题中可体现嘉宾身份或特殊经历
     * ✅ **故事化表达**：保留访谈的叙事性和个人色彩
   
   - **标题示例**：
     * 「从研究员到 CEO：Andy Jassy 眼中的 AWS 早期岁月」
     * 「为什么选择自研芯片：亚马逊的垂直整合战略」
     * 「开发者体验第一：关于 API 设计的五条原则」
     * 「失败的教训：AWS 历史上三次重大架构调整」

4. **行业分析报告**（如咨询公司报告、研究论文、趋势分析）
   - **特征**：强调趋势洞察、战略分析、行业对比、未来预测
   - **章节设计要求**：
     * ✅ 概念化标题：可使用「演进」「范式转移」「战略布局」等表达
     * ✅ 横向对比：跨公司、跨技术路线的对比分析
     * ✅ 深度洞察：挖掘技术背后的商业逻辑和产业趋势

5. **技术教程/最佳实践**（如官方文档、技术博客、实战指南）
   - **特征**：聚焦技术细节、实现原理、操作步骤、优化方法
   - **章节设计要求**：
     * ✅ 技术层级：按技术栈层次（硬件→系统→应用）组织
     * ✅ 步骤清晰：「准备工作」「核心实现」「测试验证」「生产部署」

**第二步：根据内容类型调整章节风格**

## 大纲章节设计原则（通用）
1. **边界清晰**: 每个章节应该有明确的主题边界，避免章节之间内容重叠或模糊
2. **逻辑连贯**: 章节之间应该有清晰的逻辑递进关系
3. **主题聚焦**: 每个章节应该聚焦一个核心论点或主题，复杂主题可以拆分为多个章节
4. **粒度适中**: 章节不宜过细（避免碎片化）也不宜过粗（避免内容过于庞杂）
   - **鼓励适度细分**：如果一个主题包含多个重要论点，建议拆分为独立章节
   - **每章一个核心**：每个章节应该围绕一个核心论点展开，便于读者理解和记忆
5. **避免跳跃**: 章节顺序应该自然流畅，避免话题突然跳转，确保读者能够顺畅地从一章过渡到下一章
6. **标题明确**: 章节标题应该清晰表达该章的核心内容，让读者一看就知道这一章讲什么

## 叙事重构原则（Narrative Re-engineering）

**你是架构师，不是速记员**。你的任务是重新设计内容的叙事结构，而非照搬原文顺序。

1. **打破原文顺序**：
   - 如果原文先讲解决方案后讲问题，你应该在大纲中将问题前置、方案后置
   - 如果原文话题跳跃、缺乏逻辑链条，你应该按主题重新聚类
   - 目标是形成「问题 → 分析 → 解决方案 → 验证」的完整逻辑闭环

2. **识别并修复叙事缺陷**：
   - ❌ 流水账式结构 → ✅ 起承转合的故事
   - ❌ 结论先行无铺垫 → ✅ 先铺垫后揭晓
   - ❌ 案例与理论割裂 → ✅ 理论-案例-总结三段式

3. **重构边界**：
   - 允许合并原文中分散但主题相同的内容
   - 允许拆分原文中过于臃肿的段落
   - **禁止**凭空添加原文没有的内容

## Keynote 专用章节设计指南

如果识别为 Keynote 类型，请遵守以下**分层设计原则**：

### 1. 章节内容分类与标题策略

根据每个章节的实际内容，选择对应的标题风格：

**A. 产品发布类章节**（约占 40-60%）
- **标题格式**：`[产品名 + 版本] + [核心亮点] + [可选：关键参数]`
- **必须包含**：产品全称、版本号/代际、核心性能指标、商用状态
- **示例**：
  * 「Trainium 2 芯片正式商用：AI 训练性能提升4倍，成本降低40%」
  * 「Aurora DSQL：全球首个无服务器分布式 SQL 数据库」
  * 「S3 Table Buckets：Apache Iceberg 表查询速度提升3倍」

**B. 理念/方法论类章节**（约占 20-30%，CTO演讲比例更高）
- **标题格式**：`[核心理念/方法论] + [关键观点或价值主张]`
- **适用场景**：技术愿景、设计哲学、工程文化、最佳实践、行业趋势
- **示例**：
  * 「云原生时代的长期主义：AWS 的基础设施承诺」
  * 「消除 AI 幻觉：自动化推理检查的工程实践」
  * 「开发者优先：从 API 设计到工具链的完整思考」
  * 「可观测性的三大支柱：日志、指标与追踪的统一」

**C. 客户案例类章节**（约占 10-20%）
- **标题格式**：`[客户名称] + [应用场景] + [关键成果/规模]`
- **示例**：
  * 「Apple Intelligence 案例：支撑全球10亿设备的云端算力架构」
  * 「摩根大通的全球多区域部署：跨地域金融服务的高可用实践」
  * 「Netflix 流媒体：每日处理 PB 级数据的实时分析架构」

**D. 技术深度解读类章节**（约占 10-20%）
- **标题格式**：`[技术挑战] + [解决方案] + [核心机制]`
- **示例**：
  * 「打破 CAP 定理的诅咒：Aurora DSQL 的分布式事务实现」
  * 「存储性能瓶颈：S3 如何通过表格式优化分析查询」

### 2. 章节组织逻辑（多种策略并用）

**策略A：按演讲结构**（推荐，保留原始叙事逻辑）
- 开场理念/愿景 → 核心产品发布 → 技术深度解读 → 客户案例 → 未来展望

**策略B：按产品线分组**
- 基础设施（芯片/计算）→ 数据服务（存储/数据库）→ AI 服务（模型/工具）→ 开发者工具

**策略C：按重要性排序**
- CEO/CTO 重点强调的内容 > 重大新品发布 > 功能增强 > 客户案例

### 3. 灵活性原则（重要）

⚠️ **不要强制所有章节都遵循产品化标题**：
- ✅ CTO/架构师演讲：可能 60-80% 是方法论和技术理念
- ✅ CEO 战略演讲：可能侧重行业趋势和商业洞察
- ✅ 产品经理演讲：才会大量使用版本号和参数化标题
- ✅ 尊重原文重心：如果原文某章节确实是在讲设计哲学，就用理念类标题

### 4. 需要避免的表达方式

❌ **产品类章节的错误**：
- 模糊版本：「新一代 AI 芯片」（应明确 Trainium 2）
- 缺失参数：「性能大幅提升」（应明确「提升4倍」）
- 主观修辞：「震撼发布」「颠覆性创新」（让数据说话）

❌ **理念类章节的错误**：
- 过度产品化：「长期主义 2.0 版本」（理念无版本号）
- 强行量化：「工程文化提升50%」（文化无法量化）

{mode_instructions}

## 章节划分与密度建议

**章节划分原则**：
1. **章节数量**：按上方模式约束生成，不要为了凑数而强行拆分或合并
   - 章节数量应自然反映原文的信息结构

2. **平衡细分与合并**：
   - 仔细阅读原文，评估每个主题在原文中的讨论深度和重要性
   - **适度细分**：对于内容丰富、论点复杂的主题，可以拆分为多个独立章节，便于读者理解
   - **保持完整性**：如果某个主题虽然篇幅不长，但对理解整体逻辑很重要，仍应独立成章

3. **为每个章节标注详细的生成指导**：
   - 评估该章节对应的原文内容量（多/中/少）
   - 评估该章节的信息密度（高/中/低）
   - 给出生成建议：简洁概括(brief) / 适度展开(moderate) / 深入分析(detailed)
   - **最重要**：在 rationale 字段中提供详细的内容范围指导，确保并发生成时章节之间不重复

3. **输出格式**：在 JSON 部分添加章节元数据，**rationale 字段必须包含以下关键信息**：

**rationale 字段编写规范**（极其重要，用于防止并发生成时内容重复）：

1. **核心内容范围**：明确指出该章节应该涵盖原文的哪些具体内容段落/主题/案例
2. **核心论点**：列出2-3个必须覆盖的关键论点、数据或案例
3. **与相邻章节的边界**：说明与前后章的区别，哪些内容应该避免讲（已在其他章节覆盖）
4. **独特价值**：该章节的独特角度或重点是什么

**示例对照**：

❌ **错误的 rationale**（太简略，不足以防止重复）：
```
"rationale": "涉及 Trainium 2 的性能提升和商用信息"
```

✅ **正确的 rationale**（详细、明确、有边界）：
```
"rationale": "专注 Trainium 2 的技术规格、性能指标和商用时间表。必须包含：(1)4倍性能提升的具体测试数据 (2)40%成本降低的计算逻辑 (3)与 Trainium 1 的对比 (4)2024年Q4商用计划。不要涉及 Trainium 3 的路线图（第3章覆盖），不要涉及 Apple 的具体使用案例（第4章覆盖）。重点是产品规格和可用性，而非应用场景。"
```

```json
{{{{
  "title_en": "[英文标题]",
  "title_cn": "[中文标题]",
  "chapters": [
    {{{{
      "index": 1,
      "title": "[章节标题]",
      "source_content_amount": "[rich/moderate/sparse]",
      "information_density": "[high/medium/low]",
      "generation_depth": "[detailed/moderate/brief]",
      "rationale": "[简短说明为什么这样建议]"
    }}}},
    ...
  ]
}}}}
```

**JSON格式关键要求**：
- 章节标题中如果包含引号，请使用中文书名号「」或『』替代，避免使用 " 或 "
- 确保生成的JSON格式完全合法，可以被标准JSON解析器解析
- 所有字符串值中的特殊字符都应该正确处理

**示例说明**：
- 如果某章节原文有3-4段详细讨论 → source_content_amount: "rich", generation_depth: "detailed"
- 如果某章节原文只有1段简单提及 → source_content_amount: "sparse", generation_depth: "brief"
- 如果某主题原文几乎没有讨论但对理解整体很重要 → 可以独立成章，标注为 sparse + brief
- 如果某主题原文完全没有提及 → 不要创建该章节

## 特殊格式要求
1. **标题输出**：首先输出JSON格式的标题信息，然后输出Markdown格式的内容
2. **引言**：
   - 激发读者阅读兴趣，准确反映整体内容
   - **必须在引言中透出内容来源**：如果原文来自特定的分析报告、研究机构或作者（如 SemiAnalysis、某位专家等），应在引言的开头或适当位置自然地提及来源
   - 来源信息应该融入引言的叙事中，而不是生硬地添加，例如："根据 SemiAnalysis 最新发布的分析报告..."、"SemiAnalysis 在其深度研究中指出..."
   - 如果能从原文中识别出具体的报告标题、发布时间或作者信息，也应适当体现
3. **大纲索引**：根据原文内容量和复杂度自适应生成章节数量，每个标题都言之有物，章节之间边界清晰、逻辑连贯
   - **内容丰富**（如长篇报告、深度分析）：建议 12-20 个章节
   - **内容适中**（如标准文章、演讲）：建议 6-12 个章节
   - **内容精简**（如短文、简报）：建议 3-6 个章节
4. **纯文本限制**：章节标题必须是纯文本，**严禁**包含 Markdown 链接格式或方括号 `[]()【】「」`，避免 TOC 跳转失效
5. **格式严格性**：不要添加任何额外的解释或章节内容

## 输出格式

**第一部分：JSON 元数据（必须包含）**
```json
{{{{
  "title_en": "[提取或生成的英文标题]",
  "title_cn": "[生成的中文标题]",
  "chapters": [
    {{{{
      "index": 1,
      "title": "[第一章标题]",
      "source_content_amount": "[rich/moderate/sparse]",
      "information_density": "[high/medium/low]",
      "generation_depth": "[detailed/moderate/brief]",
      "subsections": [
        {{{{
          "subtitle": "[子章节标题，可选]",
          "key_points": ["[该子章节必须覆盖的核心论点1]", "[核心论点2]"]
        }}}}
      ],
      "opening_hook": "[该章节的起始引子，如何开篇，用什么事实或数据引入]",
      "closing_transition": "[该章节的结尾过渡，如何与下一章衔接]",
      "must_include": ["[必须包含的关键数据点]", "[必须引用的案例]"],
      "must_exclude": ["[绝对禁止涉及的内容，已在其他章节覆盖]"],
      "prev_chapter_link": "[与上一章的逻辑关系，第一章可留空]",
      "next_chapter_link": "[与下一章的逻辑关系]",
      "rationale": "[详细的内容范围指导，至少100字]"
    }}}},
    {{{{
      "index": 2,
      "title": "[第二章标题]",
      "source_content_amount": "[rich/moderate/sparse]",
      "information_density": "[high/medium/low]",
      "generation_depth": "[detailed/moderate/brief]",
      "subsections": [...],
      "opening_hook": "...",
      "closing_transition": "...",
      "must_include": [...],
      "must_exclude": [...],
      "prev_chapter_link": "...",
      "next_chapter_link": "...",
      "rationale": "..."
    }}}}
    // ... 更多章节
  ]
}}}}
```

**第二部分：Markdown 内容**

# [中文标题]

### 引言
[这里是引言内容]

### 主要目录
1. [第一章标题]
2. [第二章标题]
...

{quality_control_rules}

---
**重要提醒**：
1. 必须首先输出完整的 JSON 格式元数据，包含所有章节的详细框架
2. **章节框架是并发生成的关键**：
   - `subsections`: 子章节列表，明确内部结构
   - `opening_hook`: 章节开篇设计，避免千篇一律
   - `closing_transition`: 章节结尾过渡，确保衔接顺畅
   - `must_include`: 必须包含的内容，避免遗漏
   - `must_exclude`: **强制负向约束** - 绝对禁止包含的内容，这是防止内容撞车的最强防火墙
   - `prev_chapter_link` 和 `next_chapter_link`: 章节间的逻辑连接
3. **rationale 字段**：必须写得足够详细（至少100字），明确区分各章节的边界
4. JSON 中的 chapters 数组必须包含每个章节的完整框架
5. 然后输出 Markdown 格式的标题、引言和大纲索引
6. 确保 JSON 格式完全合法，可以被标准解析器解析
"""
