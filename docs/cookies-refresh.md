第一步：在你的本地电脑（例如 Windows/Mac）上创建浏览器配置文件
你需要一台有图形界面的普通电脑来完成这个一次性的手动登录。

在本地电脑安装 Playwright（推荐 Playwright，它比 Selenium 更现代且易用）：

Bash

pip install playwright
playwright install chromium
创建一个 Python 脚本（例如 create_profile.py），内容如下。这个脚本的目的是启动一个非 headless 的浏览器，让你登录，然后把所有登录信息（Cookies, Tokens等）保存到一个指定的文件夹 (my-youtube-profile)。

Python

import time
from playwright.sync_api import sync_playwright
import os

# 定义你想在本地保存配置文件的路径
PROFILE_DIR = './my-youtube-profile'

# 确保路径存在
if not os.path.exists(PROFILE_DIR):
    os.makedirs(PROFILE_DIR)

print(f"将在此处创建配置文件: {os.path.abspath(PROFILE_DIR)}")

with sync_playwright() as p:
    # 启动一个持久化的上下文，这是关键
    # headless=False 会打开一个真实的浏览器窗口
    browser_context = p.chromium.launch_persistent_context(
        user_data_dir=PROFILE_DIR, 
        headless=False,
        args=["--no-sandbox"] # 在某些系统上可能需要
    )

    page = browser_context.new_page()

    # 打开 Google 登录页面
    print("启动浏览器，请在弹出的浏览器窗口中手动登录 Google 账号...")
    page.goto('https://accounts.google.com/')

    # 脚本会在这里暂停，等待你手动操作
    # 你需要完成登录、两步验证等所有操作
    # 登录成功后，可以顺便访问一下 youtube.com
    input("=== \n 当你在浏览器中完成登录后，请回到这里按 Enter 键继续... \n===")

    # 你按回车后，脚本会关闭浏览器，此时所有会话信息已保存到 PROFILE_DIR
    browser_context.close()
    print(f"登录成功！会话信息已保存到 {PROFILE_DIR} 目录。")

运行这个脚本：

Bash

python create_profile.py
这会弹出一个 Chrome 浏览器窗口。

在这个窗口里，完整地登录你的 Google 账号（包括 2FA 两步验证）。

登录成功后，回到你的终端（Terminal/CMD），按 Enter 键。

脚本会关闭浏览器。现在，你的当前目录下会有一个 my-youtube-profile 文件夹，它包含了你刚刚的登录会话。

第二步：将配置文件上传到你的 Linux VM
现在你有了包含“活”会话的 my-youtube-profile 文件夹。

将其打包：

Bash

# 在你的本地电脑上
zip -r my-youtube-profile.zip ./my-youtube-profile 
上传到你的 Linux VM（使用 scp 或其他 FTP 工具）：

Bash

# 语法: scp [本地文件] [用户名]@[服务器IP]:[服务器路径]
scp ./my-youtube-profile.zip benjamin@iZ6wegcnaj89dpkmbppxybZ:/home/benjamin/
第三步：在你的 Linux VM 上（Headless 模式）使用这个配置文件
现在，你的服务器上有这个配置文件了。你的 reinvent-insight 程序（或一个辅助脚本）可以在 Headless 模式下加载它来自动刷新和导出 Cookies。

在服务器上解压：

Bash

# 登录到你的 Linux VM
cd /home/benjamin/
unzip my-youtube-profile.zip 
在服务器上安装 Playwright：

Bash

# 确保你的 VM 上有 Python 和 pip
pip install playwright
# 注意：在 Linux 上安装浏览器依赖可能需要额外步骤
# 运行 playwright install chromium 它会尝试安装浏览器和依赖
# 如果失败，你可能需要手动安装依赖 (例如 sudo apt-get install ...)
playwright install-deps chromium 
playwright install chromium
创建“Cookies 导出脚本” (export_cookies.py) 这个脚本会以 Headless 模式启动浏览器，加载你的配置文件（它会自动刷新令牌），然后将最新的 Cookies 导出为 yt-dlp 能识别的 cookies.txt 文件。

Python

import time
from playwright.sync_api import sync_playwright
import os

# *** 确保这些路径和你的服务器环境一致 ***
PROFILE_DIR = '/home/benjamin/my-youtube-profile'
# 这是 yt-dlp 最终要读取的 cookie 文件
COOKIE_FILE = '/home/benjamin/reinvent-insight-prod/cookies.txt' 

def export_cookies_to_netscape_format(cookies):
    """将 Playwright 导出的 cookies 转换为 yt-dlp (Netscape) 格式"""
    s = "# Netscape HTTP Cookie File\n"
    s += "# http://curl.haxx.se/rfc/cookie_spec.html\n"
    s += "# This file was generated by reinvent-insight's helper script\n\n"

    for cookie in cookies:
        s += "{}\t{}\t{}\t{}\t{}\t{}\t{}\n".format(
            cookie['domain'],
            'TRUE' if cookie['domain'].startswith('.') else 'FALSE',
            cookie['path'],
            'TRUE' if cookie['secure'] else 'FALSE',
            int(cookie['expires']) if cookie['expires'] != -1 else 0,
            cookie['name'],
            cookie['value']
        )
    return s

print("以 Headless 模式启动浏览器并加载 Profile...")
with sync_playwright() as p:
    browser_context = p.chromium.launch_persistent_context(
        user_data_dir=PROFILE_DIR, 
        headless=True,  # <-- 在服务器上，我们使用 True
        args=["--no-sandbox"] # 在 Linux VM 上几乎必须加
    )

    page = browser_context.new_page()

    # 访问 YouTube 以确保会话被激活和刷新
    print("访问 YouTube 首页来激活会话...")
    try:
        page.goto('https://www.youtube.com', timeout=60000)
        # 等待页面加载一小会
        time.sleep(5) 
    except Exception as e:
        print(f"访问页面时出错: {e} (这可能不影响 cookie 提取)")

    # 提取最新的 cookies
    print("正在提取最新的 Cookies...")
    all_cookies = browser_context.cookies()

    browser_context.close()

    # 将 Cookies 写入文件
    print(f"正在将 {len(all_cookies)} 个 Cookies 写入到 {COOKIE_FILE}")
    cookie_data = export_cookies_to_netscape_format(all_cookies)
    with open(COOKIE_FILE, 'w', encoding='utf-8') as f:
        f.write(cookie_data)

    print("Cookies 导出成功！")

修改你的主程序逻辑 在你的 reinvent-insight 程序中，在调用 yt-dlp 之前，你必须先执行这个 export_cookies.py 脚本。

方案 A (在 worker.py 中调用)： 在你的 worker.py（或其他地方）的 Python 代码中，直接运行这个导出逻辑。

方案 B (Shell 脚本)： 创建一个 run.sh 脚本来编排这个任务。

示例 (方案 B)：

Bash

#!/bin/bash

# 1. 运行 Python 脚本来刷新和导出最新的 Cookies
# 假设 python3 指向你安装了 playwright 的环境
/path/to/your/.venv-dist/bin/python3 /home/benjamin/export_cookies.py

# 2. 检查 cookie 文件是否成功创建
COOKIE_FILE="/home/benjamin/reinvent-insight-prod/cookies.txt"
if [ ! -f "$COOKIE_FILE" ]; then
    echo "错误: Cookie 文件 $COOKIE_FILE 未能创建。"
    exit 1
fi

# 3. 运行你的主程序 (它会调用 yt-dlp)
# 你的主程序需要被配置为使用 --cookies $COOKIE_FILE
cd /home/benjamin/reinvent-insight-prod/
/path/to/your/.venv-dist/bin/python3 -m reinvent_insight.main  # (这只是一个例子)
通过这种方式，你每次运行任务时，都会先用 Playwright 模拟浏览器（在后台）刷新会话，拿到最新的 Cookies，然后再把这些 Cookies 喂给 yt-dlp，从而完美解决1小时过期的问题。