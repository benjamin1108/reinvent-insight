# 段落长度控制功能文档

## 概述

段落长度控制功能是自适应内容长度生成系统的重要组成部分，旨在解决生成内容中段落过长的问题。通过在提示词中明确要求模型控制段落长度，确保生成的内容更加紧凑、易读。

## 问题背景

在实施自适应长度功能后，虽然整体文章长度能够根据视频特征进行调整，但仍然存在以下问题：

1. **段落过长**：生成的段落经常超过200字，影响阅读体验
2. **内容冗余**：长段落容易包含重复或不必要的信息
3. **可读性差**：过长的段落降低了内容的可读性和理解效率

## 解决方案

### 核心策略

通过在动态提示词生成器中添加明确的段落长度控制指令：

- **段落长度控制**：每个段落控制在100-150字之间
- **段落结构要求**：每个段落包含3-5个句子
- **内容紧凑性**：确保内容紧凑且易读

### 实现位置

段落长度控制指令被添加到以下位置：

1. **动态提示词生成器** (`src/reinvent_insight/dynamic_prompt_generator.py`)
   - 章节生成提示词
   - 大纲生成提示词的详细程度配置

2. **自适应提示词模板** (`prompt/youtbe-deep-summary-adaptive.txt`)
   - 高级处理部分的长度控制指令

## 功能特性

### 1. 多级别支持

段落长度控制在所有详细程度级别中都生效：

- **简洁级别** (< 15,000字)：重点突出核心观点，段落紧凑
- **适度级别** (15,000-30,000字)：平衡深度与可读性，段落适中
- **深度级别** (> 30,000字)：全面展开论述，但仍保持段落紧凑

### 2. 一致性保证

所有生成场景都包含相同的段落长度控制要求：

```
- **段落长度控制**：每个段落控制在100-150字之间，避免生成过长的段落
- **段落结构要求**：每个段落包含3-5个句子，确保内容紧凑且易读
```

### 3. 智能调整

根据章节的目标长度和内容复杂度，动态调整段落长度控制的严格程度。

## 技术实现

### 1. 动态提示词生成器更新

在 `_get_chapter_length_instruction` 方法中添加段落控制指令：

```python
def _get_chapter_length_instruction(self, chapter_length_target: int) -> str:
    """获取章节长度指导说明"""
    min_length = int(chapter_length_target * 0.8)
    max_length = int(chapter_length_target * 1.2)
    
    return f"""
### 当前章节长度目标
- **目标长度**：{chapter_length_target:,} 字
- **允许范围**：{min_length:,} - {max_length:,} 字
- **段落长度控制**：每个段落控制在100-150字之间，避免生成过长的段落
- **段落结构要求**：每个段落包含3-5个句子，确保内容紧凑且易读
- **质量要求**：在满足长度要求的同时，确保内容质量和逻辑完整性
- **结构完整**：必须包含章节摘要、关键论点/案例、深入解读三个完整部分
"""
```

### 2. 详细程度配置更新

在所有详细程度级别的 `outline_instruction` 中添加段落控制：

```python
outline_instruction="""
## 大纲结构指导：[级别]版
- **章节设计**：...
- **标题要求**：...
- **逻辑关系**：...
- **段落长度控制**：每个段落控制在100-150字之间，确保内容紧凑
"""
```

### 3. 模板文件更新

在自适应提示词模板中添加全局段落控制指令：

```
## 高级处理
- **自动纠偏**：修正字幕中的语法/听写错误
- **专有名词**：如不确定，标注"【待核实】"
- **内容优化**：可适当合并同义段落，保持逻辑流畅
- **长度控制**：{LENGTH_CONTROL_INSTRUCTION}
- **段落长度控制**：每个段落控制在100-150字之间，避免生成过长的段落
- **段落结构要求**：每个段落包含3-5个句子，确保内容紧凑且易读
```

## 测试验证

### 1. 单元测试

创建了完整的测试套件 (`tests/test_paragraph_length_control.py`)：

- 验证章节提示词包含段落控制指令
- 验证大纲提示词包含段落控制指令
- 验证不同详细程度级别都包含段落控制
- 验证自适应提示词模板包含段落控制

### 2. 演示脚本

提供了演示脚本 (`tests/demo_paragraph_control.py`) 来展示功能效果：

```bash
python tests/demo_paragraph_control.py
```

## 使用方法

### 1. 自动应用

段落长度控制功能会在使用自适应工作流时自动应用，无需额外配置。

### 2. 手动验证

可以通过以下方式验证功能是否正常工作：

```python
from src.reinvent_insight.adaptive_length import LengthTarget
from src.reinvent_insight.dynamic_prompt_generator import DynamicPromptGenerator

# 创建长度目标
length_target = LengthTarget(
    target_length=20000,
    min_length=16000,
    max_length=24000,
    chapter_count=15,
    avg_chapter_length=1333
)

# 创建动态提示词生成器
generator = DynamicPromptGenerator("基础提示词", length_target)

# 生成章节提示词
chapter_prompt = generator.generate_chapter_prompt(
    chapter_index=1,
    chapter_title="测试章节",
    outline="测试大纲",
    transcript="测试字幕"
)

# 检查是否包含段落控制指令
assert "段落长度控制" in chapter_prompt
assert "100-150字之间" in chapter_prompt
```

## 预期效果

实施段落长度控制功能后，预期能够实现：

1. **段落长度优化**：生成的段落长度控制在100-150字之间
2. **内容紧凑性**：每个段落包含3-5个句子，内容更加紧凑
3. **可读性提升**：避免过长段落，提高内容的可读性
4. **质量保持**：在控制长度的同时，保持内容质量和逻辑完整性

## 监控和调优

### 1. 效果监控

可以通过以下指标监控段落长度控制的效果：

- 平均段落长度
- 段落长度分布
- 超长段落（>200字）的比例
- 用户反馈和满意度

### 2. 参数调优

如果需要调整段落长度控制的参数，可以修改以下位置：

- 段落长度范围：当前为100-150字，可根据需要调整
- 句子数量范围：当前为3-5个句子，可根据需要调整
- 控制严格程度：可以根据不同详细程度级别设置不同的控制标准

## 注意事项

1. **平衡性**：段落长度控制需要与内容质量保持平衡，不能为了控制长度而牺牲内容完整性
2. **灵活性**：在某些情况下（如复杂技术概念的解释），可能需要稍长的段落
3. **一致性**：确保所有生成场景都应用相同的段落长度控制标准
4. **测试验证**：在部署前充分测试，确保功能正常工作且不影响内容质量

## 总结

段落长度控制功能通过在提示词中明确要求模型控制段落长度，有效解决了自适应长度功能中段落过长的问题。该功能已经集成到动态提示词生成器和自适应提示词模板中，能够在所有详细程度级别下自动应用，显著提升了生成内容的可读性和用户体验。