<!DOCTYPE html>
<html lang="zh-CN" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>reinvent Insight - AI 驱动的 YouTube 深度分析</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/marked/marked.min.js"></script>
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 科技风格背景 */
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      background-attachment: fixed;
      min-height: 100vh;
      font-family: 'JetBrains Mono', 'Consolas', 'SFMono-Regular', Menlo, monospace, 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }

    .tech-gradient {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.8) 50%, rgba(15, 23, 42, 0.9) 100%);
      backdrop-filter: blur(10px);
    }

    .glow-effect {
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.1), 0 0 40px rgba(6, 182, 212, 0.05);
    }

    .glow-effect:hover {
      box-shadow: 0 0 30px rgba(6, 182, 212, 0.2), 0 0 60px rgba(6, 182, 212, 0.1);
      transition: box-shadow 0.3s ease;
    }

    /* 增强的 Markdown 样式 */
    .prose-tech {
      color: #e2e8f0;
      line-height: 1.8;
      font-size: 18px;
    }

    .prose-tech h1 {
      color: #06b6d4;
      font-size: 2.5rem;
      font-weight: 700;
      margin: 2rem 0 1.5rem 0;
      padding-bottom: 0.5rem;
      border-bottom: none;
      line-height: 1.2;
    }

    .prose-tech h2 {
      color: #0ea5e9;
      font-size: 2rem;
      font-weight: 600;
      margin: 2rem 0 1rem 0;
      line-height: 1.3;
      scroll-margin-top: 100px;
    }

    .prose-tech h3 {
      color: #38bdf8;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 1.5rem 0 0.75rem 0;
      line-height: 1.4;
      scroll-margin-top: 100px;
    }

    .prose-tech h4 {
      color: #7dd3fc;
      font-size: 1.25rem;
      font-weight: 600;
      margin: 1.25rem 0 0.5rem 0;
      line-height: 1.4;
      scroll-margin-top: 100px;
    }

    .prose-tech h5 {
      color: #bae6fd;
      font-size: 1.125rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem 0;
      line-height: 1.4;
      scroll-margin-top: 100px;
    }

    .prose-tech h6 {
      color: #e0f2fe;
      font-size: 1rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem 0;
      line-height: 1.4;
      scroll-margin-top: 100px;
    }

    /* === 新增: 统一标题渐变色 & 章节分隔符 === */
    .prose-tech h1,
    .prose-tech h2,
    .prose-tech h3,
    .prose-tech h4,
    .prose-tech h5,
    .prose-tech h6 {
      background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 50%, #9333ea 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* 为一级标题添加科技感分隔符 */
    .prose-tech h1::after {
      content: '';
      display: block;
      height: 2px;
      margin-top: 1rem;
      background: linear-gradient(90deg, transparent, #3b82f6, transparent);
      border-radius: 9999px;
      opacity: 0.6;
    }

    .prose-tech p {
      margin: 1.25rem 0;
      line-height: 1.8;
    }

    .prose-tech ul,
    .prose-tech ol {
      margin: 1.25rem 0;
      padding-left: 1.5rem;
      line-height: 1.7;
    }

    .prose-tech li {
      margin: 0.5rem 0;
    }

    .prose-tech blockquote {
      border-left: 3px solid #334155;
      background: rgba(51,65,85,0.10);
      color: #b6c2d1;
      padding: 0.85rem 1.2rem;
      margin: 1.5rem 0;
      border-radius: 0 8px 8px 0;
      font-style: italic;
    }

    .prose-tech code {
      background: rgba(6, 182, 212, 0.1);
      color: #06b6d4;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .prose-tech pre {
      background: #1e293b;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 1rem;
      margin: 1.5rem 0;
      overflow-x: auto;
    }

    .prose-tech pre code {
      background: none;
      color: inherit;
      padding: 0;
    }

    .prose-tech table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      overflow: hidden;
    }

    .prose-tech th,
    .prose-tech td {
      border: 1px solid #374151;
      padding: 0.75rem 1rem;
      text-align: left;
    }

    .prose-tech th {
      background: rgba(6, 182, 212, 0.1);
      color: #06b6d4;
      font-weight: 600;
    }

    .prose-tech a {
      color: #06b6d4;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s;
    }

    .prose-tech a:hover {
      border-bottom-color: #06b6d4;
    }

    .prose-tech strong {
      color: #67e8f9; /* 科技蓝青 */
      font-weight: 700;
    }

    .prose-tech em {
      color: #cbd5e1;
      font-style: italic;
    }

    .prose-tech hr {
      border: none;
      height: 2px;
      background: linear-gradient(90deg, transparent, #374151, transparent);
      margin: 2rem 0;
    }

    /* 目录样式 */
    .toc {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid #374151;
      border-radius: 12px;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .toc h3 {
      color: #06b6d4;
      margin-bottom: 1rem;
      font-size: 1.25rem;
    }

    .toc ul {
      list-style: none;
      padding: 0;
    }

    .toc li {
      margin: 0.5rem 0;
    }

    .toc a {
      color: #94a3b8;
      text-decoration: none;
      transition: all 0.2s;
      display: block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .toc a:hover {
      color: #06b6d4;
      background: rgba(6, 182, 212, 0.1);
    }

    .toc ul ul {
      margin-left: 1rem;
      border-left: 1px solid #374151;
      padding-left: 0.5rem;
    }

    /* 滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1e293b;
    }

    ::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    /* 动画效果 */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* 卡片优化 */
    .summary-card {
      display: flex;
      flex-direction: column;
      height: auto;
      min-height: 160px;
    }

    .summary-card h3 {
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      line-height: 1.4;
    }

    /* Grid 自动行高 */
    .auto-rows-fr {
      grid-auto-rows: 1fr;
    }

    /* 可调整大小阅读卡片 */
    .resizable {
      resize: horizontal; /* 恢复默认底角拖拽 */
      overflow: auto;
      max-width: 100%;
      min-width: 400px;
    }

    /* 目录拖拽分隔条 */
    .dragbar {
      width: 6px;
      cursor: col-resize;
      background: rgba(100, 116, 139, 0.4);
    }
  </style>
</head>

<body class="h-full flex flex-col" id="app">
  <!-- Header -->
  <header class="tech-gradient border-b border-gray-800 shadow-lg">
    <div class="max-w-full mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
          reinvent <span class="text-purple-400">Insight</span>
        </h1>
        <div class="hidden md:flex space-x-1">
          <button @click="currentView = 'create'"
            :class="currentView === 'create' ? 'bg-cyan-600 text-white' : 'text-gray-300 hover:text-white hover:bg-gray-700'"
            class="px-4 py-2 rounded-lg transition-all duration-200 text-sm font-medium">
            创建深度解读
          </button>
          <button @click="currentView = 'library'"
            :class="currentView === 'library' ? 'bg-cyan-600 text-white' : 'text-gray-300 hover:text-white hover:bg-gray-700'"
            class="px-4 py-2 rounded-lg transition-all duration-200 text-sm font-medium">
            浏览笔记库
          </button>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-400">
          <span class="hidden sm:inline">AI 驱动的</span> YouTube 深度分析
        </div>
        <a href="https://github.com" target="_blank" class="text-gray-400 hover:text-cyan-400 transition-colors">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z"
              clip-rule="evenodd"></path>
          </svg>
        </a>
      </div>
    </div>
  </header>

  <!-- App Root -->
  <div class="flex-1 overflow-auto">
    <!-- 创建摘要页面 -->
    <div v-if="currentView === 'create'" class="max-w-4xl mx-auto p-6 fade-in">
      <!-- Input Card -->
      <div class="tech-gradient border border-gray-700 rounded-xl p-8 shadow-2xl mb-8 glow-effect">
        <div class="text-center mb-6">
          <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-2">
            Deep Insights </h2>
          <p class="text-gray-400">输入 YouTube 链接，获得专业级技术摘要</p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2 text-cyan-400">YouTube 视频链接</label>
            <input v-model="url" :disabled="loading" type="url" placeholder="https://www.youtube.com/watch?v=..."
              class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent disabled:opacity-50 transition-all" />
          </div>

          <button :disabled="loading || !url" @click="startSummarize"
            class="w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:opacity-40 disabled:cursor-not-allowed rounded-lg text-white font-semibold transition-all duration-200 transform hover:scale-[1.02]">
            <span v-if="!loading" class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z">
                </path>
              </svg>
              开始分析
            </span>
            <span v-else class="flex items-center justify-center">
              <svg class="w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
              </svg>
              AI 分析中...
            </span>
        </button>
        </div>
      </div>
      
      <!-- Progress & Logs -->
      <div v-if="loading || logs.length"
        class="bg-gray-900/50 border border-gray-700 rounded-xl p-6 shadow-xl mb-8 backdrop-blur-sm">
        <!-- 进度条 -->
        <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden mb-4">
          <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-600 transition-all duration-300" :style="{ width: progressPercent + '%' }"></div>
        </div>
        <h3 class="text-xl font-semibold mb-4 text-cyan-400 flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          处理进度
        </h3>
        <div class="space-y-2">
          <div v-for="(log, index) in logs" :key="index" class="flex items-center text-sm slide-in">
            <div class="w-2 h-2 bg-green-500 rounded-full mr-3 flex-shrink-0"></div>
            <span class="text-gray-300">{{ log }}</span>
          </div>
          <div v-if="loading && currentStep < totalSteps" class="flex items-center text-sm text-gray-400">
            <div class="w-2 h-2 bg-cyan-500 rounded-full mr-3 animate-pulse flex-shrink-0"></div>
            <span>AI 正在处理，请稍候...</span>
          </div>
        </div>
      </div>

      <!-- Result -->
      <div v-if="summary" class="fade-in">
        <div class="bg-gray-900/30 border border-gray-700 rounded-xl p-8 shadow-2xl backdrop-blur-sm">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
              {{ title }}
            </h2>
            <button @click="viewSummary(title, summary)"
              class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-lg text-white font-medium transition-all duration-200 transform hover:scale-105">
              全屏阅读
            </button>
          </div>
          <div v-html="rendered" class="prose-tech"></div>
        </div>
      </div>
    </div>

    <!-- 笔记库页面 -->
    <div v-if="currentView === 'library'" class="max-w-6xl mx-auto p-6 fade-in">
      <div class="mb-8">
        <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-2">
          笔记库
        </h2>
        <p class="text-gray-400">浏览和管理您的 AI 分析笔记</p>
      </div>

      <!-- 加载状态 -->
      <div v-if="libraryLoading" class="flex items-center justify-center py-12">
        <div class="text-center">
          <svg class="w-8 h-8 animate-spin text-cyan-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <p class="text-gray-400">加载笔记中...</p>
        </div>
      </div>

      <!-- 笔记列表 -->
      <div v-else-if="summaries.length > 0" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 auto-rows-fr">
        <div v-for="summary in summaries" :key="summary.filename" @click="loadSummary(summary.filename)"
          class="summary-card tech-gradient border border-gray-700 rounded-xl p-6 cursor-pointer hover:border-cyan-500 transition-all duration-200 glow-effect group">
          <div class="flex-1 mb-4">
            <h3 class="text-lg font-semibold text-cyan-400 break-words leading-relaxed group-hover:text-cyan-300 transition-colors"
                :title="summary.title">
              {{ summary.title }}
            </h3>
          </div>
          <div class="space-y-2 text-sm text-gray-400 mt-auto">
            <div class="flex items-center">
              <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span class="truncate">{{ formatDate(summary.modified_at) }}</span>
            </div>
            <div class="flex items-center">
              <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                </path>
              </svg>
              <span class="truncate">{{ formatSize(summary.size) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 空状态 -->
      <div v-else class="text-center py-12">
        <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
          </path>
        </svg>
        <h3 class="text-xl font-semibold text-gray-400 mb-2">暂无笔记</h3>
        <p class="text-gray-500 mb-6">开始创建您的第一个 AI 分析笔记</p>
        <button @click="currentView = 'create'"
          class="px-6 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 rounded-lg text-white font-medium transition-all duration-200 transform hover:scale-105">
          创建摘要
        </button>
      </div>
    </div>

    <!-- 阅读页面 - 全宽布局 -->
    <div v-if="currentView === 'read'" class="w-full fade-in">
      <!-- 阅读页面头部 -->
      <div class="tech-gradient border-b border-gray-800 px-6 py-4 sticky top-0 z-10">
        <div class="flex items-center justify-between">
          <button @click="currentView = 'library'"
            class="flex items-center px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            返回笔记库
          </button>

          <div class="flex items-center space-x-4">
            <button @click="shareDocument" :disabled="shareLoading"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-white transition-colors flex items-center">
              <svg v-if="!shareLoading" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
              </svg>
              <svg v-else class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              {{ shareLoading ? '生成中...' : '分享' }}
            </button>
            <button @click="toggleToc"
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors">
              {{ showToc ? '隐藏目录' : '显示目录' }}
            </button>
          </div>
        </div>
      </div>

      <div class="flex">
        <!-- 目录侧边栏 -->
        <div v-if="showToc" :style="{ width: tocWidth + 'px' }" class="w-[26rem] flex-shrink-0 border-r border-gray-800 bg-gray-900/30">
          <div class="sticky top-20 p-6">
            <div class="toc">
              <h3>目录</h3>
              <div v-html="tocHtml" @click="handleTocClick"></div>
            </div>
          </div>
        </div>

        <!-- 拖拽分隔条 -->
        <div v-if="showToc" class="dragbar" @mousedown="initDrag"></div>

        <!-- 文章内容 - 全宽 -->
        <div class="flex-1 min-w-0">
          <div class="max-w-none px-4 py-8">
            <div v-if="readingContent" class="tech-gradient border border-gray-700 rounded-xl p-10 shadow-2xl backdrop-blur-sm resizable">
              <div v-html="readingContent" class="prose-tech max-w-none"></div>
            </div>
            <div v-else class="text-center py-12">
              <svg class="w-8 h-8 animate-spin text-cyan-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
              </svg>
              <p class="text-gray-400">加载中...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast 提示 -->
  <div v-if="showToastModal" class="fixed top-4 right-4 z-50 max-w-sm">
    <div 
      :class="{
        'bg-green-600 border-green-500': toastType === 'success',
        'bg-red-600 border-red-500': toastType === 'error',
        'bg-blue-600 border-blue-500': toastType === 'info'
      }"
      class="border rounded-lg p-4 shadow-lg text-white fade-in"
    >
      <div class="flex items-center">
        <svg v-if="toastType === 'success'" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <svg v-else-if="toastType === 'error'" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <svg v-else class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span class="text-sm font-medium">{{ toastMessage }}</span>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    // 配置 marked 和 highlight.js
    marked.setOptions({
      highlight: function (code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          try {
            return hljs.highlight(code, { language: lang }).value;
          } catch (__) { }
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
      gfm: true
    });

    createApp({
      setup() {
        // 状态管理
        const currentView = ref('library');
        const url = ref('');
        const loading = ref(false);
        const logs = ref([]);
        const totalSteps = 4;
        const currentStep = ref(0); // 0-4
        const summary = ref('');
        const title = ref('');

        // 笔记库相关
        const summaries = ref([]);
        const libraryLoading = ref(false);

        // 阅读页面相关
        const readingContent = ref('');
        const showToc = ref(true);
        const tocHtml = ref('');
        const currentFilename = ref('');
        
        // 分享相关状态  
        const shareLoading = ref(false);
        
        // Toast 提示相关状态
        const toastMessage = ref('');
        const toastType = ref(''); // success, error, info
        const showToastModal = ref(false);

        // 计算属性
        const rendered = computed(() => marked.parse(summary.value));
        const progressPercent = computed(() => {
          return ((currentStep.value) / totalSteps) * 100;
        });

        // 工具函数
        const formatDate = (timestamp) => {
          return new Date(timestamp * 1000).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        };

        const formatSize = (bytes) => {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        };

        // ---------- 新增: 渲染 Markdown 并生成目录 ----------
        const slugify = (str) => {
          return str.toLowerCase()
            .replace(/[^\w\u4e00-\u9fa5\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '');
        };

        const renderMarkdownWithToc = (markdown) => {
          // 使用 marked 渲染 Markdown -> HTML
          const rawHtml = marked.parse(markdown);

          // 使用 DOMParser 解析 HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(rawHtml, 'text/html');

          // 收集所有标题
          const headings = [...doc.body.querySelectorAll('h1,h2,h3,h4,h5,h6')];

          let tocHtml = '<ul>';
          let currentLevel = 1;

          headings.forEach(h => {
            const level = parseInt(h.tagName.substring(1));
            const text = h.textContent.replace(/\s*\(#.+\)$/g, '').trim();
            const id = slugify(text);
            // 给标题添加 id
            h.id = id;

            // 构建目录 HTML
            if (level > currentLevel) {
              tocHtml += '<ul>'.repeat(level - currentLevel);
            } else if (level < currentLevel) {
              tocHtml += '</ul>'.repeat(currentLevel - level);
            }
            tocHtml += `<li><a data-target="${id}">${text}</a></li>`;
            currentLevel = level;
          });
          tocHtml += '</ul>'.repeat(currentLevel);

          return { html: doc.body.innerHTML, tocHtml };
        };

        // ---------- 修改: loadSummary ----------
        const loadSummary = async (filename) => {
          try {
            const res = await axios.get(`/summaries/${filename}`);
            const { html, tocHtml: tocString } = renderMarkdownWithToc(res.data.content);
            readingContent.value = html;
            tocHtml.value = tocString;
            currentFilename.value = filename;
            currentView.value = 'read';
          } catch (e) {
            console.error('加载摘要失败:', e);
          }
        };

        // ---------- 修改: viewSummary ----------
        const viewSummary = (summaryTitle, summaryContent) => {
          const { html, tocHtml: tocString } = renderMarkdownWithToc(summaryContent);
          readingContent.value = html;
          tocHtml.value = tocString;
          // 从标题推断文件名
          currentFilename.value = summaryTitle + ".md";
          currentView.value = 'read';
        };

        // WebSocket 连接
        const connectWebSocket = (taskId) => {
          const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${wsProtocol}//${window.location.host}/ws/${taskId}`;
          const ws = new WebSocket(wsUrl);

          ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'result') {
              summary.value = data.summary;
              title.value = data.title;
              loading.value = false;
              currentStep.value = totalSteps; // 完成
              // 刷新笔记库
              loadSummaries();
            } else if (data.message) {
              // 根据关键字映射简洁步骤并更新进度
              const msg = data.message;
              if (msg.includes('下载字幕')) {
                currentStep.value = 1;
                logs.value = ['下载字幕中...'];
              } else if (msg.includes('成功下载')) {
                currentStep.value = 2;
                logs.value = ['字幕下载完成'];
              } else if (msg.includes('调用')) {
                currentStep.value = 3;
                logs.value = ['生成摘要中...'];
              } else if (msg.includes('摘要已保存')) {
                currentStep.value = 4;
                logs.value = ['摘要已保存'];
              } else if (msg.includes('摘要完成')) {
                currentStep.value = totalSteps;
                logs.value = ['完成'];
              } else if (msg.startsWith('错误')) {
                logs.value.push(msg);
              }
            }
          };

          ws.onerror = (event) => {
            logs.value.push("WebSocket 连接错误。");
            loading.value = false;
          };

          ws.onclose = (event) => {
            logs.value.push("连接已关闭。");
            if (!summary.value) {
              loading.value = false;
            }
          };
        };

        // API 调用
        const startSummarize = async () => {
          logs.value = [];
          summary.value = '';
          title.value = '';
          loading.value = true;
          
          try {
            const res = await axios.post('/summarize', { url: url.value });
            const taskId = res.data.task_id;
            logs.value.push("任务已创建，正在连接实时日志...");
            connectWebSocket(taskId);
          } catch (e) {
            const errorMsg = e.response?.data?.detail || '创建任务失败';
            logs.value.push(`错误: ${errorMsg}`);
            loading.value = false;
          }
        };

        const loadSummaries = async () => {
          libraryLoading.value = true;
          try {
            const res = await axios.get('/summaries');
            summaries.value = res.data.summaries;
          } catch (e) {
            console.error('加载摘要列表失败:', e);
          } finally {
            libraryLoading.value = false;
          }
        };

        const toggleToc = () => {
          showToc.value = !showToc.value;
        };

        // 分享功能 - 简化版
        const shareDocument = async () => {
          if (!currentFilename.value) {
            showToast('请先选择要分享的文档', 'error');
            return;
          }
          
          if (shareLoading.value) return;
          
          try {
            shareLoading.value = true;
            const res = await axios.post(`/share/${currentFilename.value}`);
            const fullUrl = `${window.location.origin}/share/${res.data.share_token}`;
            
            // 直接复制到剪贴板
            await copyToClipboard(fullUrl);
            showToast('分享链接已复制到剪贴板！', 'success');
          } catch (e) {
            console.error('创建分享链接失败:', e);
            showToast('创建分享链接失败，请稍后重试', 'error');
          } finally {
            shareLoading.value = false;
          }
        };

        // 复制到剪贴板的通用函数
        const copyToClipboard = async (text) => {
          try {
            await navigator.clipboard.writeText(text);
          } catch (e) {
            // 降级处理：选择文本
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
                      }
          };

        // Toast 提示功能
        const showToast = (message, type = 'info') => {
          toastMessage.value = message;
          toastType.value = type;
          showToastModal.value = true;
          
          // 3秒后自动隐藏
          setTimeout(() => {
            showToastModal.value = false;
          }, 3000);
        };

        // 处理目录点击
        const handleTocClick = (event) => {
          const target = event.target;
          if (target.tagName.toLowerCase() === 'a' && target.dataset.target) {
            event.preventDefault();
            const id = target.dataset.target;
            const el = document.getElementById(id);
            if (el) {
              el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }
        };

        // 拖拽侧栏分隔条
        const tocWidth = ref(Math.round(window.innerWidth / 3.7));

        const initDrag = (e) => {
          e.preventDefault();
          const startX = e.clientX;
          const startW = tocWidth.value;

          const onMove = (ev) => {
            const newW = Math.max(280, startW + (ev.clientX - startX));
            tocWidth.value = newW;
          };

          const onUp = () => {
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onUp);
          };

          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
        };

        // 生命周期
        onMounted(() => {
          loadSummaries();
        });

        return {
          currentView,
          url,
          loading,
          logs,
          summary,
          title,
          rendered,
          summaries,
          libraryLoading,
          readingContent,
          showToc,
          tocHtml,
          currentFilename,
          shareLoading,
          toastMessage,
          toastType,
          showToastModal,
          formatDate,
          formatSize,
          startSummarize,
          loadSummaries,
          loadSummary,
          viewSummary,
          toggleToc,
          shareDocument,
          showToast,
          handleTocClick,
          tocWidth,
          initDrag,
          progressPercent,
          currentStep,
          totalSteps
        };
      },
    }).mount('#app');
  </script>
</body>

</html> 