<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€§èƒ½ä¼˜åŒ–æµ‹è¯•</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #111827;
      color: #e5e7eb;
    }
    
    .test-section {
      background: #1f2937;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .test-section h2 {
      margin-top: 0;
      color: #22d3ee;
    }
    
    .metric {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #374151;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    
    .metric-label {
      font-weight: 500;
    }
    
    .metric-value {
      font-family: 'Courier New', monospace;
      color: #22d3ee;
    }
    
    .good { color: #10b981; }
    .warning { color: #f59e0b; }
    .bad { color: #ef4444; }
    
    button {
      background: #22d3ee;
      color: #111827;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 10px;
    }
    
    button:hover {
      background: #06b6d4;
    }
    
    .log {
      background: #111827;
      border: 1px solid #374151;
      border-radius: 4px;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    
    .log-entry {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1>ğŸš€ å‰ç«¯æ€§èƒ½ä¼˜åŒ–æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>ç»„ä»¶é…ç½®åˆ†æ</h2>
    <div id="component-analysis"></div>
  </div>
  
  <div class="test-section">
    <h2>åŠ è½½æ€§èƒ½æµ‹è¯•</h2>
    <button onclick="runLoadTest()">è¿è¡ŒåŠ è½½æµ‹è¯•</button>
    <button onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
    <button onclick="showReport()">æ˜¾ç¤ºæŠ¥å‘Š</button>
    <div id="load-test-results" style="margin-top: 20px;"></div>
  </div>
  
  <div class="test-section">
    <h2>å®æ—¶æ—¥å¿—</h2>
    <div id="log" class="log"></div>
  </div>

  <!-- åŠ è½½æ ¸å¿ƒæ¨¡å— -->
  <script src="/js/core/event-bus.js"></script>
  <script src="/js/core/cache-manager.js"></script>
  <script src="/js/core/performance-monitor.js"></script>
  <script src="/js/core/resource-hints.js"></script>
  <script src="/js/core/component-loader.js"></script>
  <script src="/js/core/loading-strategy.js"></script>

  <script>
    // æ—¥å¿—ç³»ç»Ÿ
    const logContainer = document.getElementById('log');
    const originalConsoleLog = console.log;
    const originalConsoleWarn = console.warn;
    const originalConsoleError = console.error;
    
    function addLog(message, type = 'log') {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.style.color = type === 'error' ? '#ef4444' : type === 'warn' ? '#f59e0b' : '#e5e7eb';
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    console.log = function(...args) {
      originalConsoleLog.apply(console, args);
      addLog(args.join(' '), 'log');
    };
    
    console.warn = function(...args) {
      originalConsoleWarn.apply(console, args);
      addLog(args.join(' '), 'warn');
    };
    
    console.error = function(...args) {
      originalConsoleError.apply(console, args);
      addLog(args.join(' '), 'error');
    };

    // ç»„ä»¶é…ç½®ï¼ˆä»app.jså¤åˆ¶ï¼‰
    const components = [
      {
        name: 'app-header',
        path: '/components/common/AppHeader',
        fileName: 'AppHeader',
        critical: true,
        priority: 1,
        version: '1.0.0'
      },
      {
        name: 'toast-container',
        path: '/components/common/ToastContainer',
        fileName: 'ToastContainer',
        critical: true,
        priority: 1,
        version: '1.0.0'
      },
      {
        name: 'hero-section',
        path: '/components/views/HeroSection',
        fileName: 'HeroSection',
        critical: false,
        priority: 4,
        version: '1.0.0'
      },
      {
        name: 'library-view',
        path: '/components/views/LibraryView',
        fileName: 'LibraryView',
        critical: false,
        priority: 4,
        version: '1.0.0'
      },
      {
        name: 'recent-view',
        path: '/components/views/RecentView',
        fileName: 'RecentView',
        critical: false,
        priority: 4,
        version: '1.0.0'
      },
      {
        name: 'reading-view',
        path: '/components/views/ReadingView',
        fileName: 'ReadingView',
        critical: false,
        priority: 4,
        version: '1.0.0'
      }
    ];

    // åˆ†æç»„ä»¶é…ç½®
    function analyzeComponents() {
      const { critical, nonCritical } = window.LoadingStrategy.categorizeComponents(components);
      
      const analysisDiv = document.getElementById('component-analysis');
      analysisDiv.innerHTML = `
        <div class="metric">
          <span class="metric-label">æ€»ç»„ä»¶æ•°</span>
          <span class="metric-value">${components.length}</span>
        </div>
        <div class="metric">
          <span class="metric-label">å…³é”®ç»„ä»¶æ•°</span>
          <span class="metric-value ${critical.length <= 3 ? 'good' : 'warning'}">${critical.length}</span>
        </div>
        <div class="metric">
          <span class="metric-label">éå…³é”®ç»„ä»¶æ•°</span>
          <span class="metric-value">${nonCritical.length}</span>
        </div>
        <div class="metric">
          <span class="metric-label">å…³é”®ç»„ä»¶å æ¯”</span>
          <span class="metric-value ${critical.length / components.length <= 0.3 ? 'good' : 'warning'}">
            ${((critical.length / components.length) * 100).toFixed(1)}%
          </span>
        </div>
      `;
      
      console.log('âœ… ç»„ä»¶é…ç½®åˆ†æå®Œæˆ');
      console.log(`å…³é”®ç»„ä»¶: ${critical.map(c => c.name || c[0]).join(', ')}`);
      console.log(`éå…³é”®ç»„ä»¶: ${nonCritical.map(c => c.name || c[0]).join(', ')}`);
    }

    // è¿è¡ŒåŠ è½½æµ‹è¯•
    async function runLoadTest() {
      console.log('ğŸš€ å¼€å§‹åŠ è½½æµ‹è¯•...');
      
      // æ¸…é™¤ä¹‹å‰çš„æ€§èƒ½æ•°æ®
      window.PerformanceMonitor.clear();
      
      const startTime = performance.now();
      
      try {
        // é¢„åŠ è½½å…³é”®ç»„ä»¶
        const criticalComponents = components.filter(c => c.critical);
        console.log(`ğŸ”— é¢„åŠ è½½ ${criticalComponents.length} ä¸ªå…³é”®ç»„ä»¶...`);
        window.ResourceHints.preloadComponents(criticalComponents);
        
        // æ¨¡æ‹ŸVueåº”ç”¨ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        const mockApp = {
          component: (name, def) => {
            console.log(`âœ… æ³¨å†Œç»„ä»¶: ${name}`);
          }
        };
        
        // ä½¿ç”¨å…³é”®ç»„ä»¶ä¼˜å…ˆç­–ç•¥åŠ è½½
        const results = await window.LoadingStrategy.loadCriticalFirst(mockApp, components, {
          useCache: false, // ç¦ç”¨ç¼“å­˜ä»¥æµ‹è¯•çœŸå®åŠ è½½æ—¶é—´
          timeout: 5000,
          onProgress: (loaded, total, name, phase) => {
            console.log(`ğŸ“¦ [${phase}] åŠ è½½è¿›åº¦: ${loaded}/${total} - ${name}`);
          },
          onCriticalComplete: (results) => {
            const criticalTime = performance.now() - startTime;
            console.log(`âœ… å…³é”®ç»„ä»¶åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${criticalTime.toFixed(2)}ms`);
          }
        });
        
        const totalTime = performance.now() - startTime;
        
        // æ˜¾ç¤ºç»“æœ
        const report = window.PerformanceMonitor.getReport();
        const resultsDiv = document.getElementById('load-test-results');
        
        const successCount = results.filter(r => r.success).length;
        const failCount = results.filter(r => !r.success).length;
        
        resultsDiv.innerHTML = `
          <div class="metric">
            <span class="metric-label">æ€»åŠ è½½æ—¶é—´</span>
            <span class="metric-value ${totalTime < 5000 ? 'good' : totalTime < 10000 ? 'warning' : 'bad'}">
              ${totalTime.toFixed(2)}ms
            </span>
          </div>
          <div class="metric">
            <span class="metric-label">æˆåŠŸåŠ è½½</span>
            <span class="metric-value good">${successCount} / ${results.length}</span>
          </div>
          <div class="metric">
            <span class="metric-label">åŠ è½½å¤±è´¥</span>
            <span class="metric-value ${failCount === 0 ? 'good' : 'bad'}">${failCount}</span>
          </div>
          <div class="metric">
            <span class="metric-label">å¹³å‡åŠ è½½æ—¶é—´</span>
            <span class="metric-value">${report.averageLoadTime.toFixed(2)}ms</span>
          </div>
          <div class="metric">
            <span class="metric-label">æœ€æ…¢ç»„ä»¶</span>
            <span class="metric-value ${report.slowestComponent?.loadTime < 2000 ? 'good' : 'warning'}">
              ${report.slowestComponent?.name || 'N/A'} (${report.slowestComponent?.loadTime.toFixed(2) || 0}ms)
            </span>
          </div>
        `;
        
        console.log('âœ… åŠ è½½æµ‹è¯•å®Œæˆ');
        console.log(`ğŸ“Š æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`);
        console.log(`ğŸ“Š å¹³å‡è€—æ—¶: ${report.averageLoadTime.toFixed(2)}ms`);
        
      } catch (error) {
        console.error('âŒ åŠ è½½æµ‹è¯•å¤±è´¥:', error);
      }
    }

    // æ¸…é™¤ç¼“å­˜
    function clearCache() {
      window.ComponentLoader.clearCache();
      window.PerformanceMonitor.clear();
      window.ResourceHints.clear();
      console.log('ğŸ—‘ï¸ ç¼“å­˜å·²æ¸…é™¤');
    }

    // æ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Š
    function showReport() {
      console.log('ğŸ“Š ===== æ€§èƒ½æŠ¥å‘Š =====');
      window.PerformanceMonitor.printReport();
      
      const report = window.PerformanceMonitor.getReport();
      console.log('ğŸ“Š æ—¶é—´çº¿:');
      report.timeline.forEach(entry => {
        console.log(`  ${entry.component}: ${entry.duration.toFixed(2)}ms ${entry.cacheHit ? '(ç¼“å­˜)' : ''}`);
      });
    }

    // é¡µé¢åŠ è½½æ—¶åˆ†æç»„ä»¶
    window.addEventListener('load', () => {
      analyzeComponents();
      console.log('âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
    });
  </script>
</body>
</html>
