<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS æµå¼æ’­æ”¾æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #22d3ee;
        }
        
        h2 {
            color: #3b82f6;
            font-size: 1.2em;
            margin-top: 0;
        }
        
        button {
            background: linear-gradient(135deg, #22d3ee, #3b82f6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-info { color: #22d3ee; }
        .log-error { color: #ef4444; }
        .log-success { color: #10b981; }
        .log-warning { color: #f59e0b; }
        
        .status {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .status-item {
            background: #1a1a1a;
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #3a3a3a;
        }
        
        .status-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .status-value {
            color: #22d3ee;
            font-size: 18px;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #3a3a3a;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #22d3ee, #3b82f6);
            width: 0%;
            transition: width 0.1s linear;
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #e0e0e0;
            padding: 10px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <h1>ğŸµ TTS æµå¼æ’­æ”¾æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ–‡æœ¬</h2>
        <textarea id="testText">äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨å¿«é€Ÿå‘å±•ï¼Œæ·±åº¦å­¦ä¹ ã€è‡ªç„¶è¯­è¨€å¤„ç†ã€è®¡ç®—æœºè§†è§‰ç­‰é¢†åŸŸå–å¾—äº†çªç ´æ€§è¿›å±•ã€‚å¤§å‹è¯­è¨€æ¨¡å‹çš„å‡ºç°ï¼Œä½¿å¾—æœºå™¨èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œç”Ÿæˆäººç±»è¯­è¨€ã€‚è¿™äº›æŠ€æœ¯çš„åº”ç”¨èŒƒå›´è¶Šæ¥è¶Šå¹¿ï¼Œä»æ™ºèƒ½åŠ©æ‰‹åˆ°è‡ªåŠ¨é©¾é©¶ï¼Œä»åŒ»ç–—è¯Šæ–­åˆ°é‡‘èåˆ†æï¼Œäººå·¥æ™ºèƒ½æ­£åœ¨æ”¹å˜æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼ã€‚ç„¶è€Œï¼Œéšç€æŠ€æœ¯çš„å‘å±•ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å…³æ³¨AIçš„ä¼¦ç†é—®é¢˜ã€æ•°æ®éšç§å’Œå®‰å…¨æ€§ã€‚å¦‚ä½•ç¡®ä¿AIæŠ€æœ¯çš„å‘å±•ç¬¦åˆäººç±»çš„åˆ©ç›Šï¼Œæ˜¯æˆ‘ä»¬éœ€è¦å…±åŒæ€è€ƒçš„é‡è¦è¯¾é¢˜ã€‚</textarea>
        
        <div style="margin-top: 10px;">
            <button id="playBtn">â–¶ï¸ æ’­æ”¾</button>
            <button id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>
            <button id="clearLogBtn">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-label">çŠ¶æ€</div>
                <div class="status-value" id="statusText">å°±ç»ª</div>
            </div>
            <div class="status-item">
                <div class="status-label">å½“å‰æ—¶é—´</div>
                <div class="status-value" id="currentTime">00:00</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ€»æ—¶é•¿</div>
                <div class="status-value" id="duration">00:00</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ¥æ”¶å—æ•°</div>
                <div class="status-value" id="chunkCount">0</div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“‹ æ—¥å¿—</h2>
        <div class="log" id="logContainer"></div>
    </div>
    
    <script type="module">
        import { AudioPlayer } from '/utils/AudioPlayer.js';
        
        let audioPlayer = null;
        let chunkCount = 0;
        
        const elements = {
            playBtn: document.getElementById('playBtn'),
            stopBtn: document.getElementById('stopBtn'),
            clearLogBtn: document.getElementById('clearLogBtn'),
            testText: document.getElementById('testText'),
            statusText: document.getElementById('statusText'),
            currentTime: document.getElementById('currentTime'),
            duration: document.getElementById('duration'),
            chunkCount: document.getElementById('chunkCount'),
            progressFill: document.getElementById('progressFill'),
            logContainer: document.getElementById('logContainer')
        };
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            elements.logContainer.appendChild(entry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
        }
        
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updateStatus(status) {
            elements.statusText.textContent = status;
        }
        
        function updateProgress() {
            if (!audioPlayer) return;
            
            const current = audioPlayer.getCurrentTime();
            const total = audioPlayer.getDuration();
            
            elements.currentTime.textContent = formatTime(current);
            elements.duration.textContent = formatTime(total);
            
            if (total > 0) {
                const percentage = (current / total) * 100;
                elements.progressFill.style.width = `${percentage}%`;
            }
        }
        
        function setupAudioPlayer() {
            if (audioPlayer) {
                audioPlayer.destroy();
            }
            
            audioPlayer = new AudioPlayer();
            chunkCount = 0;
            elements.chunkCount.textContent = '0';
            
            // ç›‘å¬äº‹ä»¶
            audioPlayer.on('play', () => {
                log('â–¶ï¸ æ’­æ”¾å¼€å§‹', 'success');
                updateStatus('æ’­æ”¾ä¸­');
                elements.playBtn.textContent = 'â¸ï¸ æš‚åœ';
                elements.playBtn.disabled = false;
                elements.stopBtn.disabled = false;
            });
            
            audioPlayer.on('pause', () => {
                log('â¸ï¸ æ’­æ”¾æš‚åœ', 'warning');
                updateStatus('å·²æš‚åœ');
                elements.playBtn.textContent = 'â–¶ï¸ ç»§ç»­';
                elements.playBtn.disabled = false;
            });
            
            audioPlayer.on('stop', () => {
                log('â¹ï¸ æ’­æ”¾åœæ­¢', 'info');
                updateStatus('å·²åœæ­¢');
                elements.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
                elements.playBtn.disabled = false;
                elements.stopBtn.disabled = true;
                updateProgress();
            });
            
            audioPlayer.on('ended', () => {
                log('âœ… æ’­æ”¾å®Œæˆ', 'success');
                updateStatus('å·²å®Œæˆ');
                elements.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
                elements.playBtn.disabled = false;
                elements.stopBtn.disabled = true;
            });
            
            audioPlayer.on('error', (error) => {
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                updateStatus('é”™è¯¯');
                elements.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
                elements.playBtn.disabled = false;
                elements.stopBtn.disabled = true;
            });
            
            audioPlayer.on('timeupdate', (time) => {
                updateProgress();
            });
            
            audioPlayer.on('durationchange', (duration) => {
                log(`â±ï¸ æ—¶é•¿æ›´æ–°: ${formatTime(duration)}`, 'info');
                updateProgress();
            });
            
            // æ‹¦æˆª console.log æ¥æ•è· chunk æ¥æ”¶
            const originalLog = console.log;
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('ğŸ“¦ æ”¶åˆ°éŸ³é¢‘å—')) {
                    chunkCount++;
                    elements.chunkCount.textContent = chunkCount;
                    log(`ğŸ“¦ æ”¶åˆ°ç¬¬ ${chunkCount} ä¸ªéŸ³é¢‘å—`, 'info');
                } else if (message.includes('ğŸµ è°ƒåº¦éŸ³é¢‘å—')) {
                    log(message, 'info');
                }
                originalLog.apply(console, args);
            };
        }
        
        // æ’­æ”¾/æš‚åœæŒ‰é’®
        elements.playBtn.addEventListener('click', async () => {
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œæš‚åœ
            if (audioPlayer && audioPlayer.isPlaying) {
                log('â¸ï¸ è¯·æ±‚æš‚åœ', 'info');
                audioPlayer.pause();
                return;
            }

            // å¦‚æœå·²æš‚åœï¼Œæ¢å¤æ’­æ”¾
            if (audioPlayer && audioPlayer.isPaused) {
                log('â–¶ï¸ æ¢å¤æ’­æ”¾', 'info');
                audioPlayer.resume();
                return;
            }

            try {
                const text = elements.testText.value.trim();
                if (!text) {
                    log('âŒ è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬', 'error');
                    return;
                }
                
                log('ğŸš€ å¼€å§‹åŠ è½½éŸ³é¢‘...', 'info');
                updateStatus('åŠ è½½ä¸­');
                
                setupAudioPlayer();
                
                const requestData = {
                    article_hash: 'test_' + Date.now(),
                    text: text,
                    voice: 'kore',  // Gemini TTS é»˜è®¤éŸ³è‰²
                    language: 'zh-CN',
                    use_cache: false,  // æµ‹è¯•æ—¶ä¸ä½¿ç”¨ç¼“å­˜
                    skip_code_blocks: true
                };
                
                // loadFromStream ç°åœ¨æ˜¯éé˜»å¡çš„ï¼Œç«‹å³è¿”å›
                await audioPlayer.loadFromStream(requestData);
                
                log('âœ… æµå¼åŠ è½½å·²å¯åŠ¨', 'success');
                
            } catch (error) {
                log(`âŒ æ’­æ”¾å¤±è´¥: ${error.message}`, 'error');
                updateStatus('é”™è¯¯');
                elements.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
                elements.playBtn.disabled = false;
                elements.stopBtn.disabled = true;
            }
        });
        
        // åœæ­¢æŒ‰é’®
        elements.stopBtn.addEventListener('click', () => {
            if (audioPlayer) {
                audioPlayer.stop();
            }
        });
        
        // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
        elements.clearLogBtn.addEventListener('click', () => {
            elements.logContainer.innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        });
        
        // åˆå§‹åŒ–
        log('ğŸµ TTS æµå¼æ’­æ”¾æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
        log('ğŸ“ è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬ï¼Œç„¶åç‚¹å‡»æ’­æ”¾æŒ‰é’®', 'info');
        
        // å®šæœŸæ›´æ–°è¿›åº¦
        setInterval(updateProgress, 100);
    </script>
</body>
</html>
