<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»„ä»¶åŠ è½½æ€§èƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e5e7eb;
    }
    
    h1 {
      color: #22d3ee;
    }
    
    .test-section {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .test-section h2 {
      color: #60a5fa;
      margin-top: 0;
    }
    
    button {
      background: #22d3ee;
      color: #1a1a1a;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
    }
    
    button:hover {
      background: #06b6d4;
    }
    
    .result {
      background: #374151;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    
    .success {
      color: #10b981;
    }
    
    .warning {
      color: #f59e0b;
    }
    
    .error {
      color: #ef4444;
    }
    
    .metric {
      display: inline-block;
      margin: 10px 20px 10px 0;
    }
    
    .metric-label {
      color: #9ca3af;
      font-size: 12px;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #22d3ee;
    }
  </style>
</head>
<body>
  <h1>ğŸš€ ç»„ä»¶åŠ è½½æ€§èƒ½æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>1. CacheManager æµ‹è¯•</h2>
    <button onclick="testCacheManager()">è¿è¡Œæµ‹è¯•</button>
    <div id="cache-result" class="result"></div>
  </div>
  
  <div class="test-section">
    <h2>2. PerformanceMonitor æµ‹è¯•</h2>
    <button onclick="testPerformanceMonitor()">è¿è¡Œæµ‹è¯•</button>
    <div id="perf-result" class="result"></div>
  </div>
  
  <div class="test-section">
    <h2>3. LoadingStrategy æµ‹è¯•</h2>
    <button onclick="testLoadingStrategy()">è¿è¡Œæµ‹è¯•</button>
    <div id="strategy-result" class="result"></div>
  </div>
  
  <div class="test-section">
    <h2>4. æ€§èƒ½åŸºå‡†æµ‹è¯•</h2>
    <button onclick="runBenchmark()">è¿è¡ŒåŸºå‡†æµ‹è¯•</button>
    <div id="benchmark-result" class="result"></div>
    <div id="benchmark-metrics"></div>
  </div>
  
  <div class="test-section">
    <h2>5. å¯¼å‡ºæ€§èƒ½æŠ¥å‘Š</h2>
    <button onclick="exportReport('json')">å¯¼å‡º JSON</button>
    <button onclick="exportReport('csv')">å¯¼å‡º CSV</button>
    <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
  </div>

  <!-- åŠ è½½æ ¸å¿ƒæ¨¡å— -->
  <script src="/js/core/cache-manager.js"></script>
  <script src="/js/core/performance-monitor.js"></script>
  <script src="/js/core/component-loader.js"></script>
  <script src="/js/core/loading-strategy.js"></script>
  
  <script>
    // æµ‹è¯• CacheManager
    function testCacheManager() {
      const result = document.getElementById('cache-result');
      result.innerHTML = 'è¿è¡Œä¸­...';
      
      try {
        // æ¸…ç©ºç¼“å­˜
        CacheManager.clear();
        CacheManager.resetStats();
        
        const tests = [];
        
        // æµ‹è¯•1: åŸºæœ¬å­˜å–
        const testData = { name: 'test', template: '<div>test</div>' };
        CacheManager.set('test-key', testData);
        const retrieved = CacheManager.get('test-key');
        tests.push({
          name: 'åŸºæœ¬å­˜å–',
          pass: retrieved && retrieved.name === 'test'
        });
        
        // æµ‹è¯•2: ç¼“å­˜å‘½ä¸­
        CacheManager.get('test-key');
        const stats = CacheManager.getStats();
        tests.push({
          name: 'ç¼“å­˜å‘½ä¸­ç»Ÿè®¡',
          pass: stats.hits === 2 && stats.hitRate === 1
        });
        
        // æµ‹è¯•3: ç¼“å­˜æœªå‘½ä¸­
        CacheManager.get('non-existent');
        const stats2 = CacheManager.getStats();
        tests.push({
          name: 'ç¼“å­˜æœªå‘½ä¸­ç»Ÿè®¡',
          pass: stats2.misses === 1
        });
        
        // æµ‹è¯•4: TTLè¿‡æœŸ
        CacheManager.set('expire-test', testData, { ttl: 100 });
        setTimeout(() => {
          const expired = CacheManager.get('expire-test');
          tests.push({
            name: 'TTLè¿‡æœŸ',
            pass: expired === null
          });
          
          displayTestResults(result, tests);
        }, 150);
        
        // å…ˆæ˜¾ç¤ºå‰3ä¸ªæµ‹è¯•ç»“æœ
        setTimeout(() => {
          displayTestResults(result, tests.slice(0, 3));
        }, 10);
        
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
      }
    }
    
    // æµ‹è¯• PerformanceMonitor
    function testPerformanceMonitor() {
      const result = document.getElementById('perf-result');
      result.innerHTML = 'è¿è¡Œä¸­...';
      
      try {
        PerformanceMonitor.clear();
        const tests = [];
        
        // æµ‹è¯•1: è®¡æ—¶åŠŸèƒ½
        PerformanceMonitor.start('test-timer');
        setTimeout(() => {
          const duration = PerformanceMonitor.end('test-timer');
          tests.push({
            name: 'è®¡æ—¶åŠŸèƒ½',
            pass: duration >= 50 && duration < 100
          });
          
          // æµ‹è¯•2: ç»„ä»¶åŠ è½½è®°å½•
          PerformanceMonitor.recordComponentLoad('test-component', {
            loadTime: 123,
            cacheHit: true,
            fileSize: 1024
          });
          
          const metrics = PerformanceMonitor.getComponentMetrics('test-component');
          tests.push({
            name: 'ç»„ä»¶åŠ è½½è®°å½•',
            pass: metrics && metrics.loadTime === 123
          });
          
          // æµ‹è¯•3: æ€§èƒ½æŠ¥å‘Š
          const report = PerformanceMonitor.getReport();
          tests.push({
            name: 'æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ',
            pass: report && report.componentCount === 1
          });
          
          displayTestResults(result, tests);
        }, 50);
        
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
      }
    }
    
    // æµ‹è¯• LoadingStrategy
    function testLoadingStrategy() {
      const result = document.getElementById('strategy-result');
      result.innerHTML = 'è¿è¡Œä¸­...';
      
      try {
        const tests = [];
        
        // æµ‹è¯•ç»„ä»¶é…ç½®
        const components = [
          { name: 'comp1', path: '/test', critical: true, priority: 1 },
          { name: 'comp2', path: '/test', critical: false, priority: 5 },
          { name: 'comp3', path: '/test', critical: true, priority: 2 }
        ];
        
        // æµ‹è¯•1: ç»„ä»¶åˆ†ç±»
        const { critical, nonCritical } = LoadingStrategy.categorizeComponents(components);
        tests.push({
          name: 'ç»„ä»¶åˆ†ç±»',
          pass: critical.length === 2 && nonCritical.length === 1
        });
        
        // æµ‹è¯•2: ä¼˜å…ˆçº§æ’åº
        tests.push({
          name: 'ä¼˜å…ˆçº§æ’åº',
          pass: critical[0].priority === 1 && critical[1].priority === 2
        });
        
        // æµ‹è¯•3: ç­–ç•¥å»ºè®®
        const recommendation = LoadingStrategy.getStrategyRecommendation(components);
        tests.push({
          name: 'ç­–ç•¥å»ºè®®',
          pass: recommendation.strategy === 'critical-first'
        });
        
        displayTestResults(result, tests);
        
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
      }
    }
    
    // è¿è¡ŒåŸºå‡†æµ‹è¯•
    async function runBenchmark() {
      const result = document.getElementById('benchmark-result');
      const metrics = document.getElementById('benchmark-metrics');
      result.innerHTML = 'è¿è¡ŒåŸºå‡†æµ‹è¯•...';
      metrics.innerHTML = '';
      
      try {
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        CacheManager.clear();
        CacheManager.resetStats();
        PerformanceMonitor.clear();
        
        // æ¨¡æ‹Ÿç»„ä»¶åŠ è½½
        const componentCount = 10;
        const startTime = performance.now();
        
        for (let i = 0; i < componentCount; i++) {
          const name = `component-${i}`;
          const loadTime = Math.random() * 500 + 100; // 100-600ms
          
          // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
          await new Promise(resolve => setTimeout(resolve, loadTime));
          
          // è®°å½•æ€§èƒ½
          PerformanceMonitor.recordComponentLoad(name, {
            loadTime,
            cacheHit: i > 5, // ååŠéƒ¨åˆ†æ¨¡æ‹Ÿç¼“å­˜å‘½ä¸­
            fileSize: Math.random() * 10000 + 1000
          });
          
          // å­˜å…¥ç¼“å­˜
          CacheManager.set(`cache-${name}`, { name, data: 'test' });
        }
        
        const totalTime = performance.now() - startTime;
        
        // è·å–ç»Ÿè®¡ä¿¡æ¯
        const perfReport = PerformanceMonitor.getReport();
        const cacheStats = CacheManager.getStats();
        
        // æ˜¾ç¤ºç»“æœ
        result.innerHTML = `
          <span class="success">âœ… åŸºå‡†æµ‹è¯•å®Œæˆ</span><br>
          æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms<br>
          ç»„ä»¶æ•°é‡: ${componentCount}<br>
          å¹³å‡åŠ è½½æ—¶é—´: ${perfReport.averageLoadTime.toFixed(2)}ms<br>
          ç¼“å­˜å‘½ä¸­ç‡: ${(perfReport.cacheHitRate * 100).toFixed(1)}%
        `;
        
        // æ˜¾ç¤ºæŒ‡æ ‡
        metrics.innerHTML = `
          <div class="metric">
            <div class="metric-label">æ€»åŠ è½½æ—¶é—´</div>
            <div class="metric-value">${totalTime.toFixed(0)}ms</div>
          </div>
          <div class="metric">
            <div class="metric-label">å¹³å‡åŠ è½½æ—¶é—´</div>
            <div class="metric-value">${perfReport.averageLoadTime.toFixed(0)}ms</div>
          </div>
          <div class="metric">
            <div class="metric-label">ç¼“å­˜å‘½ä¸­ç‡</div>
            <div class="metric-value">${(perfReport.cacheHitRate * 100).toFixed(0)}%</div>
          </div>
          <div class="metric">
            <div class="metric-label">ç¼“å­˜æ¡ç›®</div>
            <div class="metric-value">${cacheStats.entryCount}</div>
          </div>
        `;
        
        // æ£€æŸ¥æ€§èƒ½ç›®æ ‡
        const checks = [];
        checks.push({
          name: 'å¹³å‡åŠ è½½æ—¶é—´ < 500ms',
          pass: perfReport.averageLoadTime < 500,
          value: `${perfReport.averageLoadTime.toFixed(2)}ms`
        });
        checks.push({
          name: 'ç¼“å­˜å‘½ä¸­ç‡ > 30%',
          pass: perfReport.cacheHitRate > 0.3,
          value: `${(perfReport.cacheHitRate * 100).toFixed(1)}%`
        });
        
        result.innerHTML += '<br><br><strong>æ€§èƒ½ç›®æ ‡æ£€æŸ¥:</strong><br>';
        checks.forEach(check => {
          const icon = check.pass ? 'âœ…' : 'âŒ';
          const className = check.pass ? 'success' : 'error';
          result.innerHTML += `<span class="${className}">${icon} ${check.name}: ${check.value}</span><br>`;
        });
        
      } catch (error) {
        result.innerHTML = `<span class="error">âŒ åŸºå‡†æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
      }
    }
    
    // å¯¼å‡ºæŠ¥å‘Š
    function exportReport(format) {
      try {
        const data = PerformanceMonitor.export(format);
        const blob = new Blob([data], { 
          type: format === 'json' ? 'application/json' : 'text/csv' 
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `performance-report.${format}`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert(`æ€§èƒ½æŠ¥å‘Šå·²å¯¼å‡ºä¸º ${format.toUpperCase()} æ ¼å¼`);
      } catch (error) {
        alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
      }
    }
    
    // æ¸…é™¤æ‰€æœ‰æ•°æ®
    function clearAllData() {
      CacheManager.clear();
      CacheManager.resetStats();
      PerformanceMonitor.clear();
      alert('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
    }
    
    // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
    function displayTestResults(element, tests) {
      let html = '';
      tests.forEach(test => {
        const icon = test.pass ? 'âœ…' : 'âŒ';
        const className = test.pass ? 'success' : 'error';
        html += `<span class="${className}">${icon} ${test.name}</span><br>`;
      });
      
      const passed = tests.filter(t => t.pass).length;
      const total = tests.length;
      html += `<br><strong>é€šè¿‡: ${passed}/${total}</strong>`;
      
      element.innerHTML = html;
    }
  </script>
</body>
</html>
