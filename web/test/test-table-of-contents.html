<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TableOfContents 组件测试</title>
  
  <!-- Vue 3 -->
  <script src="/js/vendor/vue.global.js"></script>
  
  <!-- 基础样式 -->
  <link rel="stylesheet" href="/css/base/typography.css">
  <link rel="stylesheet" href="/css/base/effects.css">
  
  <!-- 组件样式 -->
  <link rel="stylesheet" href="/components/common/TableOfContents/TableOfContents.css">
  
  <!-- 测试框架样式 -->
  <style>
    :root {
      --test-bg: #0f172a;
      --test-surface: #1e293b;
      --test-border: #334155;
      --test-primary: #22d3ee;
      --test-success: #10b981;
      --test-warning: #f59e0b;
      --test-error: #ef4444;
      --test-text: #e5e7eb;
      --test-text-dim: #9ca3af;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--test-bg);
      color: var(--test-text);
      font-family: var(--font-primary);
      min-height: 100vh;
      padding: 2rem;
    }
    
    .test-header {
      text-align: center;
      margin-bottom: 3rem;
    }
    
    .test-header h1 {
      font-size: 2.5rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 0.5rem;
    }
    
    .test-header p {
      color: var(--test-text-dim);
      font-size: 1.125rem;
    }
    
    .test-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .test-case {
      background: var(--test-surface);
      border: 1px solid var(--test-border);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .test-case-header {
      margin-bottom: 1.5rem;
    }
    
    .test-case-title {
      font-size: 1.25rem;
      color: var(--test-primary);
    }
    
    .test-case-description {
      color: var(--test-text-dim);
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    
    .test-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 2rem;
      margin-top: 1.5rem;
    }
    
    /* 测试页面的TOC包装器，避免与组件内部的.toc-container冲突 */
    .toc-wrapper {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 1rem;
      max-height: 600px;
      position: sticky;
      top: 2rem;
    }
    
    .content-area {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 2rem;
    }
    
    .content-section {
      margin-bottom: 3rem;
      scroll-margin-top: 2rem;
    }
    
    .content-section h2 {
      color: var(--test-primary);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--test-border);
    }
    
    .content-section h3 {
      color: var(--test-text);
      margin: 1.5rem 0 0.75rem;
    }
    
    .content-section p {
      color: var(--test-text-dim);
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    
    .test-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }
    
    .test-button {
      padding: 0.5rem 1.5rem;
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .test-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
    }
    
    .test-button.secondary {
      background: var(--test-surface);
      border: 1px solid var(--test-border);
    }
    
    .status-display {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    
    .status-item {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .status-label {
      color: var(--test-text-dim);
      font-size: 0.875rem;
    }
    
    .status-value {
      font-weight: 600;
      color: var(--test-primary);
    }
    
    .test-output {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--test-border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      font-family: var(--font-code);
      font-size: 0.875rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .back-link {
      position: fixed;
      top: 2rem;
      right: 2rem;
      padding: 0.5rem 1rem;
      background: var(--test-surface);
      border: 1px solid var(--test-primary);
      border-radius: 6px;
      color: var(--test-primary);
      text-decoration: none;
      font-size: 0.875rem;
      transition: all 0.2s;
      z-index: 100;
    }
    
    .back-link:hover {
      background: rgba(34, 211, 238, 0.1);
    }
    
    .highlight {
      background: rgba(34, 211, 238, 0.2);
      padding: 0.125rem 0.25rem;
      border-radius: 4px;
    }
    
          @media (max-width: 768px) {
      .test-layout {
        grid-template-columns: 1fr;
      }
      
      .toc-wrapper {
        position: static;
        max-height: 400px;
      }
    }
  </style>
</head>
<body>
  <a href="/test/" class="back-link">← 返回测试目录</a>
  
  <div id="app">
    <div class="test-header">
      <h1>TableOfContents 组件测试</h1>
      <p>文档目录导航组件，支持多级标题和滚动监听</p>
    </div>
    
    <div class="test-container">
      <!-- 测试用例1：基础功能 -->
      <div class="test-case">
        <div class="test-case-header">
          <h2 class="test-case-title">基础功能测试</h2>
          <p class="test-case-description">标准文档结构的目录导航</p>
        </div>
        
        <div class="test-layout">
          <div class="toc-wrapper">
            <table-of-contents
              :sections="defaultSections"
              :current-section="currentSection1"
              @navigate="handleNavigate1"
            ></table-of-contents>
          </div>
          
          <div class="content-area">
            <div v-for="section in defaultSections" :key="section.id" :id="section.id" class="content-section">
              <h2>{{ section.title }}</h2>
              <p>{{ section.description || '这是 ' + section.title + ' 的内容。' }}</p>
              
              <div v-if="section.subsections">
                <div v-for="sub in section.subsections" :key="sub.id" :id="sub.id">
                  <h3>{{ sub.title }}</h3>
                  <p>{{ sub.description || '这是 ' + sub.title + ' 的子章节内容。' }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="status-display">
          <div class="status-item">
            <span class="status-label">当前章节:</span>
            <span class="status-value">{{ currentSection1 || '未选择' }}</span>
          </div>
        </div>
      </div>
      
      <!-- 测试用例2：动态内容 -->
      <div class="test-case">
        <div class="test-case-header">
          <h2 class="test-case-title">动态内容测试</h2>
          <p class="test-case-description">动态添加/删除章节</p>
        </div>
        
        <div class="test-controls">
          <button @click="addSection" class="test-button">
            添加章节
          </button>
          <button @click="removeSection" class="test-button secondary">
            删除章节
          </button>
          <button @click="addSubsection" class="test-button secondary">
            添加子章节
          </button>
          <button @click="toggleExpanded" class="test-button secondary">
            {{ allExpanded ? '折叠全部' : '展开全部' }}
          </button>
        </div>
        
        <div class="test-layout">
          <div class="toc-wrapper">
            <table-of-contents
              :sections="dynamicSections"
              :current-section="currentSection2"
              :expanded="expandedSections"
              @navigate="handleNavigate2"
              @toggle="handleToggle"
            ></table-of-contents>
          </div>
          
          <div class="content-area">
            <div v-for="section in dynamicSections" :key="section.id" :id="section.id" class="content-section">
              <h2>{{ section.title }}</h2>
              <p>{{ section.description }}</p>
              
              <div v-if="section.subsections">
                <div v-for="sub in section.subsections" :key="sub.id" :id="sub.id">
                  <h3>{{ sub.title }}</h3>
                  <p>{{ sub.description }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="status-display">
          <div class="status-item">
            <span class="status-label">章节数:</span>
            <span class="status-value">{{ dynamicSections.length }}</span>
          </div>
          <div class="status-item">
            <span class="status-label">当前章节:</span>
            <span class="status-value">{{ currentSection2 || '未选择' }}</span>
          </div>
          <div class="status-item">
            <span class="status-label">展开状态:</span>
            <span class="status-value">{{ Object.values(expandedSections).filter(v => v).length }} / {{ dynamicSections.length }}</span>
          </div>
        </div>
      </div>
      
      <!-- 测试用例3：滚动监听 -->
      <div class="test-case">
        <div class="test-case-header">
          <h2 class="test-case-title">滚动监听测试</h2>
          <p class="test-case-description">模拟滚动位置变化，自动高亮当前章节</p>
        </div>
        
        <div class="test-controls">
          <button @click="simulateScroll('intro')" class="test-button secondary">
            滚动到介绍
          </button>
          <button @click="simulateScroll('getting-started')" class="test-button secondary">
            滚动到快速开始
          </button>
          <button @click="simulateScroll('api-auth')" class="test-button secondary">
            滚动到 API 认证
          </button>
          <button @click="simulateRandomScroll" class="test-button">
            随机滚动
          </button>
        </div>
        
        <div class="test-layout">
          <div class="toc-wrapper">
            <table-of-contents
              :sections="scrollTestSections"
              :current-section="currentSection3"
              :scroll-spy="true"
              @navigate="handleNavigate3"
            ></table-of-contents>
          </div>
          
          <div class="content-area" style="max-height: 400px; overflow-y: auto;" @scroll="handleScroll" ref="scrollContainer">
            <div v-for="section in scrollTestSections" :key="section.id" :id="section.id" class="content-section">
              <h2>{{ section.title }}</h2>
              <p v-for="i in 5" :key="i">
                这是 {{ section.title }} 的第 {{ i }} 段内容。Lorem ipsum dolor sit amet, consectetur adipiscing elit.
              </p>
              
              <div v-if="section.subsections">
                <div v-for="sub in section.subsections" :key="sub.id" :id="sub.id">
                  <h3>{{ sub.title }}</h3>
                  <p v-for="i in 3" :key="i">
                    这是 {{ sub.title }} 的第 {{ i }} 段内容。Sed do eiusmod tempor incididunt ut labore.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="status-display">
          <div class="status-item">
            <span class="status-label">当前可见章节:</span>
            <span class="status-value">{{ currentSection3 || '未检测到' }}</span>
          </div>
          <div class="status-item">
            <span class="status-label">滚动位置:</span>
            <span class="status-value">{{ scrollPosition }}px</span>
          </div>
        </div>
      </div>
      
      <!-- 测试用例4：拖动功能测试 -->
      <div class="test-case">
        <div class="test-case-header">
          <h2 class="test-case-title">拖动功能测试</h2>
          <p class="test-case-description">测试目录宽度调整功能</p>
        </div>
        
        <div style="display: flex; height: 500px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; overflow: hidden;">
          <table-of-contents
            :sections="defaultSections"
            :width="300"
            :min-width="200"
            :max-width="500"
            @width-change="handleWidthChange"
          ></table-of-contents>
          
          <div style="flex: 1; padding: 2rem;">
            <h3>内容区域</h3>
            <p>拖动目录右侧的拖动条可以调整目录宽度。</p>
            <p>最小宽度：200px，最大宽度：500px</p>
          </div>
        </div>
      </div>
      
      <!-- 事件日志 -->
      <div class="test-case">
        <div class="test-case-header">
          <h2 class="test-case-title">事件日志</h2>
        </div>
        
        <button @click="clearLog" class="test-button secondary">
          清空日志
        </button>
        
        <div class="test-output">
          <div v-if="eventLog.length === 0" style="color: var(--test-text-dim);">
            暂无事件记录
          </div>
          <div v-for="(log, index) in eventLog" :key="index">
            {{ log }}
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 组件加载器 -->
  <script src="/js/core/component-loader.js"></script>
  
  <script type="module">
    const { createApp, ref, reactive, onMounted, onUnmounted, nextTick } = Vue;
    
    const app = createApp({
      setup() {
        // 默认章节数据
        const defaultSections = [
          {
            id: 'introduction',
            title: '介绍',
            description: '这是项目的介绍部分，包含了基本概念和核心特性。'
          },
          {
            id: 'getting-started',
            title: '快速开始',
            subsections: [
              { id: 'installation', title: '安装' },
              { id: 'configuration', title: '配置' },
              { id: 'first-steps', title: '第一步' }
            ]
          },
          {
            id: 'api-reference',
            title: 'API 参考',
            subsections: [
              { id: 'api-auth', title: '认证' },
              { id: 'api-users', title: '用户接口' },
              { id: 'api-data', title: '数据接口' }
            ]
          },
          {
            id: 'advanced',
            title: '高级功能',
            subsections: [
              { id: 'performance', title: '性能优化' },
              { id: 'security', title: '安全考虑' }
            ]
          },
          {
            id: 'faq',
            title: '常见问题'
          }
        ];
        
        const currentSection1 = ref('');
        
        // 动态内容测试
        const dynamicSections = ref([...defaultSections.slice(0, 3)]);
        const currentSection2 = ref('');
        const expandedSections = reactive({});
        const allExpanded = ref(false);
        
        // 滚动测试
        const scrollTestSections = [...defaultSections];
        const currentSection3 = ref('');
        const scrollPosition = ref(0);
        const scrollContainer = ref(null);
        
        // 事件日志
        const eventLog = ref([]);
        
        const addLog = (message) => {
          const time = new Date().toLocaleTimeString();
          eventLog.value.unshift(`[${time}] ${message}`);
          if (eventLog.value.length > 50) {
            eventLog.value.pop();
          }
        };
        
        // 导航处理
        const handleNavigate1 = (sectionId) => {
          currentSection1.value = sectionId;
          addLog(`基础测试：导航到 ${sectionId}`);
          
          // 模拟滚动到对应章节
          const element = document.getElementById(sectionId);
          if (element) {
            element.scrollIntoView({ behavior: 'smooth' });
          }
        };
        
        const handleNavigate2 = (sectionId) => {
          currentSection2.value = sectionId;
          addLog(`动态测试：导航到 ${sectionId}`);
        };
        
        const handleNavigate3 = (sectionId) => {
          currentSection3.value = sectionId;
          addLog(`滚动测试：导航到 ${sectionId}`);
          
          if (scrollContainer.value) {
            const element = scrollContainer.value.querySelector(`#${sectionId}`);
            if (element) {
              element.scrollIntoView({ behavior: 'smooth' });
            }
          }
        };
        
        // 展开/折叠处理
        const handleToggle = (sectionId) => {
          expandedSections[sectionId] = !expandedSections[sectionId];
          addLog(`切换章节 ${sectionId} 展开状态：${expandedSections[sectionId] ? '展开' : '折叠'}`);
        };
        
        // 动态操作
        const addSection = () => {
          const newId = `section-${Date.now()}`;
          dynamicSections.value.push({
            id: newId,
            title: `新章节 ${dynamicSections.value.length + 1}`,
            description: '这是动态添加的章节内容。'
          });
          addLog(`添加新章节：${newId}`);
        };
        
        const removeSection = () => {
          if (dynamicSections.value.length > 0) {
            const removed = dynamicSections.value.pop();
            addLog(`删除章节：${removed.id}`);
          }
        };
        
        const addSubsection = () => {
          if (dynamicSections.value.length > 0) {
            const lastSection = dynamicSections.value[dynamicSections.value.length - 1];
            if (!lastSection.subsections) {
              lastSection.subsections = [];
            }
            const newId = `subsection-${Date.now()}`;
            lastSection.subsections.push({
              id: newId,
              title: `子章节 ${lastSection.subsections.length + 1}`,
              description: '这是动态添加的子章节内容。'
            });
            addLog(`在 ${lastSection.id} 下添加子章节：${newId}`);
          }
        };
        
        const toggleExpanded = () => {
          allExpanded.value = !allExpanded.value;
          dynamicSections.value.forEach(section => {
            if (section.subsections) {
              expandedSections[section.id] = allExpanded.value;
            }
          });
          addLog(`${allExpanded.value ? '展开' : '折叠'}所有章节`);
        };
        
        // 滚动模拟
        const simulateScroll = (sectionId) => {
          currentSection3.value = sectionId;
          addLog(`模拟滚动到：${sectionId}`);
        };
        
        const simulateRandomScroll = () => {
          const allIds = [];
          scrollTestSections.forEach(section => {
            allIds.push(section.id);
            if (section.subsections) {
              section.subsections.forEach(sub => allIds.push(sub.id));
            }
          });
          
          const randomId = allIds[Math.floor(Math.random() * allIds.length)];
          simulateScroll(randomId);
        };
        
        const handleScroll = (event) => {
          scrollPosition.value = Math.round(event.target.scrollTop);
          
          // 简单的滚动监听逻辑
          const container = event.target;
          const sections = container.querySelectorAll('.content-section');
          
          for (let section of sections) {
            const rect = section.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            if (rect.top >= containerRect.top && rect.top <= containerRect.top + 100) {
              const sectionId = section.id || section.querySelector('[id]')?.id;
              if (sectionId && sectionId !== currentSection3.value) {
                currentSection3.value = sectionId;
                addLog(`滚动检测：进入章节 ${sectionId}`);
              }
              break;
            }
          }
        };
        
        const clearLog = () => {
          eventLog.value = [];
        };
        
        // 处理宽度变化
        const handleWidthChange = (width) => {
          addLog(`宽度变更: ${width}px`);
        };
        
        // 初始化展开状态
        onMounted(() => {
          dynamicSections.value.forEach(section => {
            if (section.subsections) {
              expandedSections[section.id] = true;
            }
          });
        });
        
        return {
          defaultSections,
          currentSection1,
          dynamicSections,
          currentSection2,
          expandedSections,
          allExpanded,
          scrollTestSections,
          currentSection3,
          scrollPosition,
          scrollContainer,
          eventLog,
          handleNavigate1,
          handleNavigate2,
          handleNavigate3,
          handleToggle,
          addSection,
          removeSection,
          addSubsection,
          toggleExpanded,
          simulateScroll,
          simulateRandomScroll,
          handleScroll,
          clearLog,
          handleWidthChange
        };
      }
    });
    
    // 加载组件
    (async () => {
      try {
        await ComponentLoader.registerComponents(app, [
          ['table-of-contents', '/components/common/TableOfContents', 'TableOfContents']
        ]);
        
        app.mount('#app');
        console.log('TableOfContents 测试环境初始化完成');
      } catch (error) {
        console.error('测试环境初始化失败:', error);
      }
    })();
  </script>
</body>
</html> 